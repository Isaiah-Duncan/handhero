<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HandHero | Hand Therapy Companion</title>
    <meta name="description" content="Guided hand therapy exercises with real-time tracking">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-cream: #fdfbf7;
            --color-warm-white: #faf8f5;
            --color-sage: #87a878;
            --color-sage-light: #a8c99b;
            --color-coral: #e8998d;
            --color-gold: #d4a574;
            --color-slate: #4a5568;
            --color-slate-light: #718096;
            --color-success: #68b37a;
        }
        * { box-sizing: border-box; }
        body { 
            font-family: 'Nunito', sans-serif; 
            background-color: var(--color-cream); 
            color: var(--color-slate); 
            overflow: hidden; 
            user-select: none;
        }
        *:focus-visible { outline: 3px solid var(--color-sage); outline-offset: 2px; }
        .skip-link {
            position: absolute; top: -40px; left: 0;
            background: var(--color-sage); color: white;
            padding: 8px 16px; z-index: 1000;
        }
        .skip-link:focus { top: 0; }
        #app-container { 
            position: relative; width: 100vw; height: 100vh; 
            display: flex; align-items: center; justify-content: center; 
        }
        #video-bg { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: cover; transform: scaleX(-1); 
            filter: blur(30px) opacity(0.4) saturate(0.9) sepia(0.1); z-index: 0;
        }
        #portal-wrapper { position: relative; width: 90vw; height: 85vh; max-width: 1100px; z-index: 10; }
        #portal-frame {
            position: relative; width: 100%; height: 100%; border-radius: 32px; padding: 4px; 
            background: linear-gradient(135deg, var(--color-sage), var(--color-gold), var(--color-coral));
            background-size: 200% 200%; animation: gradient-flow 10s ease infinite;
            box-shadow: 0 20px 60px -10px rgba(135, 168, 120, 0.25); transition: all 0.4s ease;
        }
        #portal-frame.holding { background: linear-gradient(135deg, var(--color-gold), #e8c9a8); box-shadow: 0 0 40px rgba(212, 165, 116, 0.5); }
        #portal-frame.success { background: linear-gradient(135deg, var(--color-success), var(--color-sage-light)); box-shadow: 0 0 60px rgba(104, 179, 122, 0.6); transform: scale(1.005); }
        #portal-frame.rest { background: linear-gradient(135deg, #a8c99b, #c9dfc0); }
        @keyframes gradient-flow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        #portal-view { width: 100%; height: 100%; background: var(--color-warm-white); border-radius: 28px; overflow: hidden; position: relative; }
        #video-clean { position: absolute; top: 50%; left: 50%; width: 100vw; height: 100vh; object-fit: cover; transform: translate(-50%, -50%) scaleX(-1); }
        #output-canvas { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; }
        #hud-layer { position: absolute; inset: 0; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; }
        .top-row { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; }
        .glass-pill {
            background: rgba(255, 255, 255, 0.92); backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.6); border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
        }
        .instruction-banner { padding: 10px 24px; display: flex; align-items: center; gap: 12px; max-width: 400px; }
        .instruction-icon { font-size: 1.5rem; }
        .instruction-text { font-size: 1.1rem; font-weight: 700; color: var(--color-slate); }
        .instruction-sub { font-size: 0.8rem; color: var(--color-slate-light); font-weight: 500; }
        .progress-pill { padding: 8px 14px; font-size: 0.75rem; font-weight: 600; color: var(--color-slate-light); }
        .stats-bar { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; }
        .stat-card { padding: 8px 16px; border-radius: 16px; display: flex; align-items: center; gap: 8px; transition: transform 0.2s; }
        .stat-card.pulse { transform: scale(1.1); background: rgba(104, 179, 122, 0.15); }
        .stat-val { font-size: 1.1rem; font-weight: 700; color: var(--color-slate); }
        .stat-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--color-slate-light); font-weight: 700; }
        .float-btn {
            position: fixed; z-index: 50; background: white; color: var(--color-slate); 
            border: 1px solid #e8e4df; box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            border-radius: 14px; padding: 12px; cursor: pointer;
            width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
        }
        .float-btn:hover { background: var(--color-warm-white); transform: translateY(-2px); }
        #btn-quit { top: 20px; left: 20px; }
        #btn-audio { top: 20px; right: 76px; }
        #btn-skip { top: 20px; right: 20px; background: #fef7ed; border-color: var(--color-gold); }
        #progress-bar-container { position: absolute; bottom: 0; left: 0; right: 0; height: 6px; background: rgba(0,0,0,0.05); border-radius: 0 0 28px 28px; overflow: hidden; }
        #progress-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--color-sage), var(--color-success)); transition: width 0.15s ease; }
        .center-feedback { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none; }
        #hold-timer { font-size: 4.5rem; font-weight: 800; color: white; text-shadow: 0 4px 30px rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.2s; }
        #hold-timer.show { opacity: 1; }
        #feedback-message { font-size: 2.5rem; font-weight: 800; color: var(--color-success); text-shadow: 0 4px 20px rgba(104, 179, 122, 0.4); opacity: 0; transform: scale(0.5); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #feedback-message.show { opacity: 1; transform: scale(1); }
        .particle { position: absolute; pointer-events: none; border-radius: 50%; animation: particle-fall 1.5s ease-out forwards; }
        @keyframes particle-fall { 0% { opacity: 1; transform: translateY(0) rotate(0deg); } 100% { opacity: 0; transform: translateY(200px) rotate(720deg); } }
        .overlay-screen {
            position: fixed; inset: 0; z-index: 100; background: rgba(253, 251, 247, 0.98);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.4s, visibility 0.4s; padding: 24px;
        }
        .overlay-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .overlay-content { max-width: 480px; width: 100%; text-align: center; }
        .btn-primary {
            background: linear-gradient(135deg, var(--color-sage) 0%, #6b9960 100%);
            padding: 16px 40px; border-radius: 20px; font-size: 1.1rem; font-weight: 700;
            color: white; box-shadow: 0 8px 24px -4px rgba(135, 168, 120, 0.4);
            border: none; cursor: pointer; min-width: 200px;
        }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: white; border: 2px solid #e8e4df; padding: 12px 28px; border-radius: 16px; font-size: 1rem; font-weight: 600; color: var(--color-slate); cursor: pointer; }
        .btn-secondary:hover { background: var(--color-warm-white); border-color: var(--color-sage); }
        .onboarding-step { display: none; }
        .onboarding-step.active { display: block; }
        .onboarding-image { font-size: 5rem; margin-bottom: 24px; }
        .onboarding-title { font-size: 1.8rem; font-weight: 800; color: var(--color-slate); margin-bottom: 12px; }
        .onboarding-desc { font-size: 1.05rem; color: var(--color-slate-light); line-height: 1.6; margin-bottom: 32px; }
        .onboarding-dots { display: flex; justify-content: center; gap: 8px; margin-bottom: 24px; }
        .onboarding-dot { width: 10px; height: 10px; border-radius: 50%; background: #e8e4df; transition: all 0.3s; }
        .onboarding-dot.active { background: var(--color-sage); width: 24px; border-radius: 5px; }
        .disclaimer-box { background: white; border: 1px solid #e8e4df; border-radius: 16px; padding: 20px; text-align: left; margin-bottom: 24px; max-height: 200px; overflow-y: auto; }
        .disclaimer-box h4 { font-weight: 700; color: var(--color-slate); margin-bottom: 8px; }
        .disclaimer-box p, .disclaimer-box ul { font-size: 0.85rem; color: var(--color-slate-light); line-height: 1.5; margin-bottom: 8px; }
        .disclaimer-box ul { padding-left: 20px; }
        .checkbox-row { display: flex; align-items: flex-start; gap: 12px; text-align: left; margin-bottom: 20px; }
        .checkbox-row input[type="checkbox"] { width: 20px; height: 20px; margin-top: 2px; accent-color: var(--color-sage); }
        .checkbox-row label { font-size: 0.9rem; color: var(--color-slate); line-height: 1.4; }
        .pain-scale { display: flex; justify-content: space-between; gap: 8px; margin: 24px 0; }
        .pain-btn { flex: 1; padding: 16px 8px; border-radius: 12px; border: 2px solid transparent; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .pain-btn:hover { transform: translateY(-2px); }
        .pain-btn.green { background: #e8f5e9; }
        .pain-btn.green:hover, .pain-btn.green.selected { border-color: #68b37a; background: #d4edda; }
        .pain-btn.yellow { background: #fff8e1; }
        .pain-btn.yellow:hover, .pain-btn.yellow.selected { border-color: #e8b44d; background: #ffecb3; }
        .pain-btn.orange { background: #fff3e0; }
        .pain-btn.orange:hover, .pain-btn.orange.selected { border-color: #e8998d; background: #ffe0b2; }
        .pain-btn.red { background: #ffebee; }
        .pain-btn.red:hover, .pain-btn.red.selected { border-color: #d97b7b; background: #ffcdd2; }
        .pain-emoji { font-size: 1.8rem; }
        .pain-label { font-size: 0.75rem; font-weight: 600; color: var(--color-slate); }
        .rest-overlay { background: rgba(168, 201, 155, 0.95); }
        .rest-timer { font-size: 4rem; font-weight: 800; color: white; text-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .rest-message { font-size: 1.3rem; color: white; margin-top: 16px; opacity: 0.9; }
        .summary-card { background: white; border: 1px solid #e8e4df; border-radius: 16px; padding: 20px; margin-bottom: 16px; }
        .summary-stat { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0ece6; }
        .summary-stat:last-child { border-bottom: none; }
        .summary-label { color: var(--color-slate-light); font-weight: 500; }
        .summary-value { color: var(--color-slate); font-weight: 700; }
        .grade-badge { display: inline-block; padding: 4px 12px; border-radius: 8px; font-weight: 700; font-size: 0.9rem; }
        .grade-a { background: #d4edda; color: #155724; }
        .grade-b { background: #fff3cd; color: #856404; }
        .grade-c { background: #ffe0b2; color: #e65100; }
        @media (prefers-reduced-motion: reduce) { *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; } }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <button id="btn-quit" class="float-btn hidden" aria-label="Exit session">‚úï</button>
    <button id="btn-audio" class="float-btn hidden" aria-label="Toggle audio">üîä</button>
    <button id="btn-skip" class="float-btn hidden" aria-label="Skip exercise">‚è≠Ô∏è</button>

    <div id="app-container" role="main" id="main-content">
        <video id="video-bg" playsinline muted autoplay aria-hidden="true"></video>
        <div id="portal-wrapper">
            <div id="portal-frame">
                <div id="portal-view">
                    <video id="video-clean" playsinline muted autoplay aria-label="Camera feed"></video>
                    <canvas id="output-canvas" aria-hidden="true"></canvas>
                    <div id="hud-layer" aria-live="polite">
                        <div class="top-row">
                            <div class="glass-pill progress-pill"><span id="exercise-progress">1 of 6</span></div>
                            <div class="glass-pill instruction-banner">
                                <span class="instruction-icon" id="instruction-icon">üëã</span>
                                <div>
                                    <div class="instruction-text" id="instruction-text">Get Ready</div>
                                    <div class="instruction-sub" id="instruction-sub">Position hand in frame</div>
                                </div>
                            </div>
                            <div class="glass-pill progress-pill"><span id="session-timer">0:00</span></div>
                        </div>
                        <div class="center-feedback">
                            <div id="hold-timer">3</div>
                            <div id="feedback-message">Nice!</div>
                        </div>
                        <div class="stats-bar">
                            <div class="glass-pill stat-card" id="streak-card">
                                <span>üî•</span>
                                <div><div id="stat-streak" class="stat-val">0</div><div class="stat-label">Streak</div></div>
                            </div>
                            <div class="glass-pill stat-card">
                                <span>‚ú®</span>
                                <div><div id="stat-completed" class="stat-val">0</div><div class="stat-label">Done</div></div>
                            </div>
                        </div>
                    </div>
                    <div id="progress-bar-container"><div id="progress-bar-fill"></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ONBOARDING OVERLAY -->
    <div id="overlay-welcome" class="overlay-screen">
        <div class="overlay-content">
            <div class="onboarding-step active" data-step="1">
                <div class="onboarding-image">üå±</div>
                <h1 class="onboarding-title">Welcome to HandHero</h1>
                <p class="onboarding-desc">Your personal hand therapy companion. Gentle exercises to improve strength and mobility.</p>
                <div class="onboarding-dots"><div class="onboarding-dot active"></div><div class="onboarding-dot"></div><div class="onboarding-dot"></div><div class="onboarding-dot"></div></div>
                <button class="btn-primary" onclick="nextStep()">Get Started</button>
            </div>
            <div class="onboarding-step" data-step="2">
                <div class="onboarding-image">‚úã</div>
                <h2 class="onboarding-title">How It Works</h2>
                <p class="onboarding-desc">Position your hand in front of the camera. Follow the on-screen instructions. Hold each position until the timer completes.</p>
                <div class="onboarding-dots"><div class="onboarding-dot"></div><div class="onboarding-dot active"></div><div class="onboarding-dot"></div><div class="onboarding-dot"></div></div>
                <button class="btn-primary" onclick="nextStep()">Next</button>
                <button class="btn-secondary" onclick="prevStep()" style="margin-top:12px">Back</button>
            </div>
            <div class="onboarding-step" data-step="3">
                <div class="onboarding-image">üí°</div>
                <h2 class="onboarding-title">Tips for Success</h2>
                <p class="onboarding-desc">‚Ä¢ Good lighting helps accuracy<br>‚Ä¢ Keep hand 12-18 inches from camera<br>‚Ä¢ Move slowly and deliberately<br>‚Ä¢ Stop if you feel any pain</p>
                <div class="onboarding-dots"><div class="onboarding-dot"></div><div class="onboarding-dot"></div><div class="onboarding-dot active"></div><div class="onboarding-dot"></div></div>
                <button class="btn-primary" onclick="nextStep()">Next</button>
                <button class="btn-secondary" onclick="prevStep()" style="margin-top:12px">Back</button>
            </div>
            <div class="onboarding-step" data-step="4">
                <div class="onboarding-image">‚öïÔ∏è</div>
                <h2 class="onboarding-title">Safety Information</h2>
                <div class="disclaimer-box">
                    <h4>Medical Disclaimer</h4>
                    <p>HandHero is a wellness tool designed to supplement, not replace, professional medical care.</p>
                    <ul><li>NOT a medical device</li><li>Does NOT provide diagnosis or treatment</li><li>Should NOT replace professional therapy</li></ul>
                    <p><strong>Stop immediately if you experience:</strong> pain, numbness, tingling, swelling, or any concerning symptoms.</p>
                </div>
                <div class="checkbox-row">
                    <input type="checkbox" id="disclaimer-check">
                    <label for="disclaimer-check">I understand this is a wellness tool. I will stop if I experience pain.</label>
                </div>
                <div class="onboarding-dots"><div class="onboarding-dot"></div><div class="onboarding-dot"></div><div class="onboarding-dot"></div><div class="onboarding-dot active"></div></div>
                <button class="btn-primary" id="btn-start" disabled onclick="startApp()">I Understand ‚Äì Start</button>
                <button class="btn-secondary" onclick="prevStep()" style="margin-top:12px">Back</button>
            </div>
        </div>
    </div>

    <!-- PAIN CHECK OVERLAY -->
    <div id="overlay-pain" class="overlay-screen hidden">
        <div class="overlay-content">
            <div class="onboarding-image">üíö</div>
            <h2 class="onboarding-title">Quick Check-In</h2>
            <p class="onboarding-desc">How is your hand feeling?</p>
            <div class="pain-scale">
                <button class="pain-btn green" onclick="selectPain(0)"><span class="pain-emoji">üòä</span><span class="pain-label">Good</span></button>
                <button class="pain-btn yellow" onclick="selectPain(1)"><span class="pain-emoji">üòê</span><span class="pain-label">Mild</span></button>
                <button class="pain-btn orange" onclick="selectPain(2)"><span class="pain-emoji">üòï</span><span class="pain-label">Moderate</span></button>
                <button class="pain-btn red" onclick="selectPain(3)"><span class="pain-emoji">üò£</span><span class="pain-label">Too Much</span></button>
            </div>
            <p id="pain-advice" style="font-size:0.9rem;color:var(--color-slate-light);min-height:40px"></p>
            <button class="btn-primary" id="btn-continue" disabled onclick="continuePain()">Continue</button>
        </div>
    </div>

    <!-- REST OVERLAY -->
    <div id="overlay-rest" class="overlay-screen rest-overlay hidden">
        <div class="overlay-content">
            <h2 class="onboarding-title" style="color:white">Take a Breath</h2>
            <div class="rest-timer" id="rest-timer">20</div>
            <p class="rest-message">Relax your hand. We'll continue shortly.</p>
            <button class="btn-secondary" onclick="skipRest()" style="margin-top:24px;background:rgba(255,255,255,0.9)">I'm Ready ‚Äì Skip</button>
        </div>
    </div>

    <!-- COMPLETE OVERLAY -->
    <div id="overlay-complete" class="overlay-screen hidden">
        <div class="overlay-content">
            <div class="onboarding-image">üéâ</div>
            <h2 class="onboarding-title">Session Complete!</h2>
            <div class="summary-card">
                <div class="summary-stat"><span class="summary-label">Exercises</span><span class="summary-value" id="sum-done">6</span></div>
                <div class="summary-stat"><span class="summary-label">Duration</span><span class="summary-value" id="sum-time">3:45</span></div>
                <div class="summary-stat"><span class="summary-label">Best Streak</span><span class="summary-value" id="sum-streak">4 üî•</span></div>
                <div class="summary-stat"><span class="summary-label">Grade</span><span class="summary-value"><span id="sum-grade" class="grade-badge grade-a">A</span></span></div>
            </div>
            <p style="font-size:0.85rem;color:var(--color-slate-light);margin-bottom:24px">Great work! Consistency is key.</p>
            <button class="btn-primary" onclick="exportReport()">üìÑ Save Report</button>
            <button class="btn-secondary" onclick="restart()" style="margin-top:12px">New Session</button>
        </div>
    </div>

    <!-- LOADING OVERLAY -->
    <div id="overlay-loading" class="overlay-screen hidden">
        <div class="overlay-content">
            <div class="onboarding-image" style="animation:pulse 1.5s infinite">üñêÔ∏è</div>
            <h2 class="onboarding-title">Preparing Session</h2>
            <p class="onboarding-desc" id="loading-msg">Loading AI model...</p>
        </div>
    </div>

<script>
// ============================================
// CONFIGURATION & CONSTANTS  
// ============================================
const CONFIG = { EXERCISES_PER_SESSION: 6, REST_SECONDS: 20, PAIN_CHECK_EVERY: 3, GOOD_THRESHOLD: 0.70, PARTIAL_THRESHOLD: 0.50, GRACE_MS: 8000 };
const FINGER = { THUMB: [1,2,3,4], INDEX: [5,6,7,8], MIDDLE: [9,10,11,12], RING: [13,14,15,16], PINKY: [17,18,19,20] };
const BONES = [[0,1],[1,2],[2,3],[3,4],[0,5],[5,6],[6,7],[7,8],[0,9],[9,10],[10,11],[11,12],[0,13],[13,14],[14,15],[15,16],[0,17],[17,18],[18,19],[19,20],[5,9],[9,13],[13,17]];

const ALL_EXERCISES = [
    { id:'starfish', name:'Starfish', icon:'üñêÔ∏è', desc:'Spread all fingers wide', skeleton:'tips', duration:1500, difficulty:1 },
    { id:'fist', name:'Gentle Fist', icon:'‚úä', desc:'Make a soft fist', skeleton:'curl', duration:1200, difficulty:1 },
    { id:'thumbs', name:'Thumbs Up', icon:'üëç', desc:'Thumb up, fingers curled', skeleton:'single', finger:'thumb', duration:1400, difficulty:2 },
    { id:'pointer', name:'Pointer', icon:'‚òùÔ∏è', desc:'Point with index finger', skeleton:'single', finger:'index', duration:1400, difficulty:2 },
    { id:'ok', name:'OK Sign', icon:'üëå', desc:'Touch thumb to index', skeleton:'pinch', targets:[4,8], duration:1200, difficulty:2 },
    { id:'peace', name:'Peace Sign', icon:'‚úåÔ∏è', desc:'Extend index and middle', skeleton:'two', fingers:['index','middle'], duration:1500, difficulty:3 },
    { id:'pinky', name:'Pinky Wave', icon:'ü§ô', desc:'Extend pinky, curl others', skeleton:'single', finger:'pinky', duration:1500, difficulty:3 },
    { id:'rock', name:'Rock On', icon:'ü§ò', desc:'Index and pinky out', skeleton:'two', fingers:['index','pinky'], duration:1800, difficulty:4 }
];

// ============================================
// STATE
// ============================================
const state = {
    step: 1, screen: 'WELCOME', handLandmarker: null, webcamRunning: false,
    exercises: [], exIdx: 0, completed: 0, streak: 0, bestStreak: 0, startTime: 0,
    holding: false, holdStart: 0, progress: 0, cooldown: false,
    curls: [0,0,0,0,0], pinchIndex: 1, pinchMiddle: 1,
    currentAcc: 0, peakAcc: 0, attemptStart: 0, hasAttempted: false,
    painLevels: [], selectedPain: null, log: [], animTime: 0
};

// ============================================
// DOM ELEMENTS
// ============================================
const $ = id => document.getElementById(id);
const el = {
    welcome: $('overlay-welcome'), loading: $('overlay-loading'), pain: $('overlay-pain'),
    rest: $('overlay-rest'), complete: $('overlay-complete'),
    videoBg: $('video-bg'), video: $('video-clean'), canvas: $('output-canvas'),
    frame: $('portal-frame'), view: $('portal-view'),
    btnQuit: $('btn-quit'), btnAudio: $('btn-audio'), btnSkip: $('btn-skip'),
    icon: $('instruction-icon'), text: $('instruction-text'), sub: $('instruction-sub'),
    progress: $('exercise-progress'), timer: $('session-timer'),
    streak: $('stat-streak'), done: $('stat-completed'), streakCard: $('streak-card'),
    holdTimer: $('hold-timer'), feedback: $('feedback-message'), bar: $('progress-bar-fill'),
    restTimer: $('rest-timer'), painAdvice: $('pain-advice'), btnContinue: $('btn-continue'),
    sumDone: $('sum-done'), sumTime: $('sum-time'), sumStreak: $('sum-streak'), sumGrade: $('sum-grade'),
    loadMsg: $('loading-msg'), disclaimerCheck: $('disclaimer-check'), btnStart: $('btn-start')
};
const ctx = el.canvas.getContext('2d');
let audioCtx = null;

// ============================================
// ONBOARDING
// ============================================
function nextStep() {
    state.step++;
    document.querySelectorAll('.onboarding-step').forEach((s,i) => s.classList.toggle('active', i+1===state.step));
    document.querySelectorAll('.onboarding-dot').forEach((d,i) => d.classList.toggle('active', i+1===state.step));
}
function prevStep() {
    state.step--;
    document.querySelectorAll('.onboarding-step').forEach((s,i) => s.classList.toggle('active', i+1===state.step));
    document.querySelectorAll('.onboarding-dot').forEach((d,i) => d.classList.toggle('active', i+1===state.step));
}
el.disclaimerCheck.addEventListener('change', e => el.btnStart.disabled = !e.target.checked);

async function startApp() {
    if (!el.disclaimerCheck.checked) return;
    el.welcome.classList.add('hidden');
    el.loading.classList.remove('hidden');
    try {
        el.loadMsg.textContent = 'Loading AI model...';
        const vision = await import("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js");
        const fs = await vision.FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
        state.handLandmarker = await vision.HandLandmarker.createFromOptions(fs, {
            baseOptions: { modelAssetPath: 'https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task', delegate: 'GPU' },
            runningMode: 'VIDEO', numHands: 1
        });
        el.loadMsg.textContent = 'Starting camera...';
        const stream = await navigator.mediaDevices.getUserMedia({ video: { width:1280, height:720, facingMode:'user' } });
        el.videoBg.srcObject = stream;
        el.video.srcObject = stream;
        el.video.addEventListener('loadeddata', () => {
            state.webcamRunning = true;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            el.loading.classList.add('hidden');
            showControls();
            beginSession();
        });
    } catch(e) {
        el.loadMsg.textContent = 'Error: ' + e.message;
    }
}

function showControls() { el.btnQuit.classList.remove('hidden'); el.btnAudio.classList.remove('hidden'); el.btnSkip.classList.remove('hidden'); }
function hideControls() { el.btnQuit.classList.add('hidden'); el.btnAudio.classList.add('hidden'); el.btnSkip.classList.add('hidden'); }

// ============================================
// SESSION MANAGEMENT
// ============================================
function selectExercises() {
    const shuffle = a => a.sort(() => Math.random() - 0.5);
    const easy = ALL_EXERCISES.filter(e => e.difficulty === 1);
    const med = ALL_EXERCISES.filter(e => e.difficulty === 2);
    const hard = ALL_EXERCISES.filter(e => e.difficulty >= 3);
    return [...shuffle(easy).slice(0,2), ...shuffle(med).slice(0,2), ...shuffle(hard).slice(0,2)];
}

function beginSession() {
    state.screen = 'SESSION';
    state.exercises = selectExercises();
    state.exIdx = 0;
    state.completed = 0;
    state.streak = 0;
    state.bestStreak = 0;
    state.startTime = Date.now();
    state.log = [];
    state.painLevels = [];
    loadExercise(0);
    gameLoop();
}

function loadExercise(idx) {
    state.exIdx = idx;
    const ex = state.exercises[idx];
    el.icon.textContent = ex.icon;
    el.text.textContent = ex.name;
    el.sub.textContent = ex.desc;
    el.progress.textContent = `${idx+1} of ${state.exercises.length}`;
    state.holding = false;
    state.progress = 0;
    state.currentAcc = 0;
    state.peakAcc = 0;
    state.attemptStart = Date.now();
    state.hasAttempted = false;
    el.bar.style.width = '0%';
    speak(ex.name + '. ' + ex.desc);
}

function gameLoop() {
    if (!state.webcamRunning || state.screen !== 'SESSION') return;
    state.animTime = Date.now() / 1000;
    try {
        const results = state.handLandmarker.detectForVideo(el.video, performance.now());
        resizeCanvas();
        ctx.clearRect(0, 0, el.canvas.width, el.canvas.height);
        if (results.landmarks && results.landmarks.length > 0) {
            const lm = results.landmarks[0];
            analyzeHand(lm);
            updateGame();
            renderSkeleton(lm);
        } else {
            state.holding = false;
            state.progress = Math.max(0, state.progress - 0.03);
            el.bar.style.width = (state.progress * 100) + '%';
            el.frame.className = '';
        }
    } catch(e) {}
    updateTimer();
    requestAnimationFrame(gameLoop);
}

function updateTimer() {
    const s = Math.floor((Date.now() - state.startTime) / 1000);
    el.timer.textContent = `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
}

// ============================================
// HAND ANALYSIS
// ============================================
function analyzeHand(lm) {
    const curl = (b, m, t) => {
        const v1 = { x: lm[m].x - lm[b].x, y: lm[m].y - lm[b].y };
        const v2 = { x: lm[t].x - lm[m].x, y: lm[t].y - lm[m].y };
        const dot = v1.x * v2.x + v1.y * v2.y;
        const mag = Math.hypot(v1.x, v1.y) * Math.hypot(v2.x, v2.y);
        return Math.max(0, Math.min(1, 1 - (dot / mag)));
    };
    state.curls = [curl(1,2,4), curl(5,6,8), curl(9,10,12), curl(13,14,16), curl(17,18,20)];
    state.pinchIndex = Math.hypot(lm[8].x - lm[4].x, lm[8].y - lm[4].y);
    state.pinchMiddle = Math.hypot(lm[12].x - lm[4].x, lm[12].y - lm[4].y);
}

// ============================================
// ACCURACY CALCULATORS
// ============================================
const Acc = {
    starfish: s => s.curls.map(c => c < 0.20 ? 1 : c < 0.35 ? 0.8 : c < 0.50 ? 0.5 : 0.2).reduce((a,b) => a+b, 0) / 5,
    fist: s => s.curls.map(c => c > 0.75 ? 1 : c > 0.60 ? 0.8 : c > 0.45 ? 0.5 : 0.2).reduce((a,b) => a+b, 0) / 5,
    thumbs: s => {
        const t = s.curls[0] < 0.35 ? 1 : s.curls[0] < 0.50 ? 0.7 : 0.3;
        const o = [s.curls[1],s.curls[2],s.curls[3],s.curls[4]].map(c => c > 0.60 ? 1 : c > 0.45 ? 0.7 : 0.3).reduce((a,b) => a+b, 0) / 4;
        return t * 0.4 + o * 0.6;
    },
    pointer: s => {
        const i = s.curls[1] < 0.30 ? 1 : s.curls[1] < 0.45 ? 0.7 : 0.3;
        const o = [s.curls[2],s.curls[3],s.curls[4]].map(c => c > 0.60 ? 1 : c > 0.45 ? 0.7 : 0.3).reduce((a,b) => a+b, 0) / 3;
        return i * 0.5 + o * 0.5;
    },
    ok: s => s.pinchIndex < 0.05 ? 1 : s.pinchIndex < 0.08 ? 0.85 : s.pinchIndex < 0.12 ? 0.65 : s.pinchIndex < 0.18 ? 0.45 : 0.2,
    peace: s => {
        const e = [s.curls[1],s.curls[2]].map(c => c < 0.30 ? 1 : c < 0.45 ? 0.7 : 0.3).reduce((a,b) => a+b, 0) / 2;
        const c = [s.curls[3],s.curls[4]].map(c => c > 0.60 ? 1 : c > 0.45 ? 0.7 : 0.3).reduce((a,b) => a+b, 0) / 2;
        return e * 0.5 + c * 0.5;
    },
    pinky: s => {
        const p = s.curls[4] < 0.30 ? 1 : s.curls[4] < 0.45 ? 0.7 : 0.3;
        const o = [s.curls[1],s.curls[2],s.curls[3]].map(c => c > 0.50 ? 1 : c > 0.35 ? 0.7 : 0.3).reduce((a,b) => a+b, 0) / 3;
        return p * 0.5 + o * 0.5;
    },
    rock: s => {
        const e = [s.curls[1],s.curls[4]].map(c => c < 0.30 ? 1 : c < 0.45 ? 0.7 : 0.3).reduce((a,b) => a+b, 0) / 2;
        const c = [s.curls[2],s.curls[3]].map(c => c > 0.60 ? 1 : c > 0.45 ? 0.7 : 0.3).reduce((a,b) => a+b, 0) / 2;
        return e * 0.5 + c * 0.5;
    }
};
function getAccuracy() { return Acc[state.exercises[state.exIdx].id]?.(state) || 0.5; }

// ============================================
// GAME LOGIC
// ============================================
function updateGame() {
    if (state.cooldown) return;
    const ex = state.exercises[state.exIdx];
    state.currentAcc = getAccuracy();
    if (state.currentAcc > state.peakAcc) state.peakAcc = state.currentAcc;
    if (state.currentAcc > 0.35 && !state.hasAttempted) { state.hasAttempted = true; state.attemptStart = Date.now(); }
    
    const elapsed = Date.now() - state.attemptStart;
    const meetsGood = state.currentAcc >= CONFIG.GOOD_THRESHOLD;
    const graceOver = state.hasAttempted && elapsed > CONFIG.GRACE_MS;
    const meetsPartial = state.peakAcc >= CONFIG.PARTIAL_THRESHOLD;
    const isHolding = state.currentAcc >= CONFIG.PARTIAL_THRESHOLD;
    
    if (isHolding) {
        if (!state.holding) { state.holding = true; state.holdStart = Date.now(); }
        const mult = 0.6 + state.currentAcc * 0.4;
        state.progress = Math.min(1, ((Date.now() - state.holdStart) / ex.duration) * mult);
        if (state.progress >= 1 && meetsGood) success(state.currentAcc, false);
        else if (graceOver && meetsPartial && state.progress >= 0.5) success(state.peakAcc, true);
    } else {
        state.holding = false;
        state.progress = Math.max(0, state.progress - 0.05);
    }
    if (graceOver && meetsPartial && !state.cooldown) success(state.peakAcc, true);
    
    el.bar.style.width = (state.progress * 100) + '%';
    el.frame.className = state.progress >= 1 ? 'success' : state.holding ? 'holding' : state.currentAcc >= CONFIG.PARTIAL_THRESHOLD ? 'holding' : '';
    if (state.holding && state.progress < 1) {
        el.holdTimer.textContent = Math.ceil((1 - state.progress) * (state.exercises[state.exIdx].duration / 1000));
        el.holdTimer.classList.add('show');
    } else el.holdTimer.classList.remove('show');
}

function success(acc, graceful) {
    state.cooldown = true;
    state.completed++;
    state.streak++;
    if (state.streak > state.bestStreak) state.bestStreak = state.streak;
    
    const ex = state.exercises[state.exIdx];
    const pct = Math.round(acc * 100);
    let grade = pct >= 90 ? 'A' : pct >= 80 ? 'A-' : pct >= 70 ? 'B' : pct >= 60 ? 'B-' : 'C';
    state.log.push({ name: ex.name, accuracy: pct, grade, graceful });
    console.log(`[HandHero] ${ex.name}: ${pct}% (${grade})${graceful ? ' [Graceful]' : ''}`);
    
    const msgs = acc >= 0.85 ? ['Perfect!','Excellent!','Amazing!'] : acc >= 0.70 ? ['Great!','Nice!','Good job!'] : ['Good effort!','Keep going!'];
    showFeedback(msgs[Math.floor(Math.random() * msgs.length)]);
    playSound();
    spawnParticles();
    
    el.done.textContent = state.completed;
    el.streak.textContent = state.streak;
    el.streakCard.classList.add('pulse');
    setTimeout(() => el.streakCard.classList.remove('pulse'), 300);
    
    setTimeout(() => {
        const next = state.exIdx + 1;
        if (state.completed > 0 && state.completed % CONFIG.PAIN_CHECK_EVERY === 0 && next < state.exercises.length) { showPainCheck(); return; }
        if (next >= state.exercises.length) endSession();
        else { loadExercise(next); state.cooldown = false; }
    }, 1200);
}

function skip() {
    if (state.cooldown || state.screen !== 'SESSION') return;
    const ex = state.exercises[state.exIdx];
    state.log.push({ name: ex.name, accuracy: Math.round(state.peakAcc * 100), grade: 'SKIP', skipped: true });
    state.streak = 0;
    el.streak.textContent = '0';
    const next = state.exIdx + 1;
    if (next >= state.exercises.length) endSession();
    else loadExercise(next);
}

// ============================================
// PAIN CHECK
// ============================================
function showPainCheck() {
    state.screen = 'PAIN';
    state.selectedPain = null;
    el.painAdvice.textContent = '';
    el.btnContinue.disabled = true;
    document.querySelectorAll('.pain-btn').forEach(b => b.classList.remove('selected'));
    el.pain.classList.remove('hidden');
}

function selectPain(lvl) {
    state.selectedPain = lvl;
    state.painLevels.push({ time: Date.now(), level: lvl });
    document.querySelectorAll('.pain-btn').forEach((b, i) => b.classList.toggle('selected', i === lvl));
    const advice = ["Great! You're doing well.", "Mild discomfort is normal.", "Let's slow down.", "Please stop and rest."];
    el.painAdvice.textContent = advice[lvl];
    el.btnContinue.disabled = false;
    el.btnContinue.textContent = lvl === 3 ? 'End Session' : 'Continue';
}

function continuePain() {
    el.pain.classList.add('hidden');
    if (state.selectedPain === 3) { endSession(); return; }
    showRest();
}

// ============================================
// REST PERIOD
// ============================================
let restInterval = null;
function showRest() {
    state.screen = 'REST';
    el.frame.className = 'rest';
    let remaining = CONFIG.REST_SECONDS;
    el.restTimer.textContent = remaining;
    el.rest.classList.remove('hidden');
    restInterval = setInterval(() => {
        remaining--;
        el.restTimer.textContent = remaining;
        if (remaining <= 0) skipRest();
    }, 1000);
}

function skipRest() {
    if (restInterval) { clearInterval(restInterval); restInterval = null; }
    el.rest.classList.add('hidden');
    el.frame.className = '';
    state.screen = 'SESSION';
    state.cooldown = false;
    const next = state.exIdx + 1;
    if (next >= state.exercises.length) endSession();
    else loadExercise(next);
}

// ============================================
// SESSION END
// ============================================
function endSession() {
    state.screen = 'COMPLETE';
    hideControls();
    const dur = Math.floor((Date.now() - state.startTime) / 1000);
    const valid = state.log.filter(l => !l.skipped);
    const avg = valid.length > 0 ? valid.reduce((s, l) => s + l.accuracy, 0) / valid.length : 0;
    let grade, cls;
    if (avg >= 85) { grade = 'A'; cls = 'grade-a'; }
    else if (avg >= 70) { grade = 'B+'; cls = 'grade-a'; }
    else if (avg >= 55) { grade = 'B'; cls = 'grade-b'; }
    else { grade = 'C'; cls = 'grade-c'; }
    
    el.sumDone.textContent = state.completed;
    el.sumTime.textContent = `${Math.floor(dur/60)}:${(dur%60).toString().padStart(2,'0')}`;
    el.sumStreak.textContent = state.bestStreak + ' üî•';
    el.sumGrade.textContent = grade;
    el.sumGrade.className = 'grade-badge ' + cls;
    el.complete.classList.remove('hidden');
    
    console.log('\n===== HANDHERO SESSION =====');
    console.table(state.log);
    console.log('Avg:', Math.round(avg) + '%');
    console.log('============================\n');
}

function restart() { el.complete.classList.add('hidden'); showControls(); beginSession(); }

function exportReport() {
    const dur = Math.floor((Date.now() - state.startTime) / 1000);
    const txt = `HANDHERO SESSION REPORT\n${new Date().toLocaleString()}\n\nExercises: ${state.completed}\nDuration: ${Math.floor(dur/60)}:${(dur%60).toString().padStart(2,'0')}\nBest Streak: ${state.bestStreak}\n\nDETAILS:\n${state.log.map(l => `${l.name}: ${l.accuracy}% (${l.grade})`).join('\n')}\n\nPain Levels: ${state.painLevels.map(p => p.level).join(', ') || 'None'}\n\n---\nGenerated by HandHero`;
    const blob = new Blob([txt], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `handhero-${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
}

// ============================================
// RENDERING
// ============================================
function resizeCanvas() {
    if (el.canvas.width !== el.view.clientWidth) {
        el.canvas.width = el.view.clientWidth;
        el.canvas.height = el.view.clientHeight;
    }
}

function project(pt) {
    const w = el.canvas.width, h = el.canvas.height;
    const scale = Math.max(w / 1280, h / 720);
    const sw = 1280 * scale, sh = 720 * scale;
    return { x: (w - sw) / 2 + (1 - pt.x) * sw, y: (h - sh) / 2 + pt.y * sh };
}

function renderSkeleton(lm) {
    const ex = state.exercises[state.exIdx];
    if (ex.skeleton === 'tips') renderTips(lm);
    else if (ex.skeleton === 'curl') renderCurl(lm);
    else if (ex.skeleton === 'single') renderSingle(lm, ex.finger);
    else if (ex.skeleton === 'two') renderTwo(lm, ex.fingers);
    else if (ex.skeleton === 'pinch') renderPinch(lm, ex.targets);
    else renderMinimal(lm);
}

function renderTips(lm) {
    const tips = [0, 4, 8, 12, 16, 20];
    ctx.strokeStyle = 'rgba(255,255,255,0.15)';
    ctx.lineWidth = 1;
    tips.slice(1).forEach(t => {
        const w = project(lm[0]), p = project(lm[t]);
        ctx.beginPath(); ctx.moveTo(w.x, w.y); ctx.lineTo(p.x, p.y); ctx.stroke();
    });
    tips.forEach((idx, i) => {
        const p = project(lm[idx]);
        const fIdx = Math.floor((idx - 1) / 4);
        const good = idx === 0 || state.curls[fIdx] < 0.30;
        const pulse = 1 + Math.sin(state.animTime * 4 + i) * 0.15;
        const size = (idx === 0 ? 14 : 12) * pulse;
        const color = good ? '#68b37a' : 'rgba(255,255,255,0.7)';
        ctx.fillStyle = color + '30'; ctx.beginPath(); ctx.arc(p.x, p.y, size + 6, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = color; ctx.beginPath(); ctx.arc(p.x, p.y, size, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(p.x, p.y, size * 0.35, 0, Math.PI * 2); ctx.fill();
    });
}

function renderCurl(lm) {
    const fingers = [FINGER.THUMB, FINGER.INDEX, FINGER.MIDDLE, FINGER.RING, FINGER.PINKY];
    fingers.forEach((f, i) => {
        const curl = state.curls[i];
        const r = 255 - curl * 187, g = 255 - curl * 33, b = 255 - curl * 127;
        const color = `rgb(${r},${g},${b})`;
        ctx.strokeStyle = color; ctx.lineWidth = 3; ctx.lineCap = 'round';
        const w = project(lm[0]), start = project(lm[f[0]]);
        ctx.beginPath(); ctx.moveTo(w.x, w.y); ctx.lineTo(start.x, start.y); ctx.stroke();
        for (let j = 0; j < f.length - 1; j++) {
            const a = project(lm[f[j]]), b = project(lm[f[j+1]]);
            ctx.beginPath(); ctx.moveTo(a.x, a.y); ctx.lineTo(b.x, b.y); ctx.stroke();
        }
        const pulse = 1 + Math.sin(state.animTime * (2 + curl * 5) + i) * 0.25;
        f.forEach(idx => {
            const p = project(lm[idx]);
            ctx.fillStyle = color; ctx.beginPath(); ctx.arc(p.x, p.y, 6 * pulse, 0, Math.PI * 2); ctx.fill();
        });
    });
    const w = project(lm[0]);
    ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(w.x, w.y, 10, 0, Math.PI * 2); ctx.fill();
}

function renderSingle(lm, fingerName) {
    const map = { thumb: FINGER.THUMB, index: FINGER.INDEX, middle: FINGER.MIDDLE, ring: FINGER.RING, pinky: FINGER.PINKY };
    const curlMap = { thumb: 0, index: 1, middle: 2, ring: 3, pinky: 4 };
    const indices = [0, ...map[fingerName]];
    const good = state.curls[curlMap[fingerName]] < 0.30;
    const color = good ? '#68b37a' : '#d4a574';
    
    ctx.strokeStyle = 'rgba(255,255,255,0.06)'; ctx.lineWidth = 1;
    BONES.forEach(([s, e]) => {
        if (!indices.includes(s) || !indices.includes(e)) {
            const a = project(lm[s]), b = project(lm[e]);
            ctx.beginPath(); ctx.moveTo(a.x, a.y); ctx.lineTo(b.x, b.y); ctx.stroke();
        }
    });
    
    ctx.strokeStyle = color; ctx.lineWidth = 4; ctx.lineCap = 'round';
    ctx.shadowColor = color; ctx.shadowBlur = 12;
    const f = map[fingerName];
    const w = project(lm[0]), start = project(lm[f[0]]);
    ctx.beginPath(); ctx.moveTo(w.x, w.y); ctx.lineTo(start.x, start.y); ctx.stroke();
    for (let i = 0; i < f.length - 1; i++) {
        const a = project(lm[f[i]]), b = project(lm[f[i+1]]);
        ctx.beginPath(); ctx.moveTo(a.x, a.y); ctx.lineTo(b.x, b.y); ctx.stroke();
    }
    ctx.shadowBlur = 0;
    
    const pulse = 1 + Math.sin(state.animTime * 5) * 0.2;
    indices.forEach(idx => {
        const p = project(lm[idx]);
        const size = (idx === 0 ? 12 : 10) * pulse;
        ctx.fillStyle = color + '40'; ctx.beginPath(); ctx.arc(p.x, p.y, size + 6, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = color; ctx.beginPath(); ctx.arc(p.x, p.y, size, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(p.x, p.y, size * 0.35, 0, Math.PI * 2); ctx.fill();
    });
}

function renderTwo(lm, fingerNames) {
    const map = { thumb: FINGER.THUMB, index: FINGER.INDEX, middle: FINGER.MIDDLE, ring: FINGER.RING, pinky: FINGER.PINKY };
    const curlMap = { thumb: 0, index: 1, middle: 2, ring: 3, pinky: 4 };
    let indices = [0];
    fingerNames.forEach(n => indices.push(...map[n]));
    const good = fingerNames.every(n => state.curls[curlMap[n]] < 0.30);
    const color = good ? '#68b37a' : '#87a878';
    
    ctx.strokeStyle = 'rgba(255,255,255,0.05)'; ctx.lineWidth = 1;
    BONES.forEach(([s, e]) => {
        if (!indices.includes(s) && !indices.includes(e)) {
            const a = project(lm[s]), b = project(lm[e]);
            ctx.beginPath(); ctx.moveTo(a.x, a.y); ctx.lineTo(b.x, b.y); ctx.stroke();
        }
    });
    
    ctx.strokeStyle = color; ctx.lineWidth = 4; ctx.lineCap = 'round';
    ctx.shadowColor = color; ctx.shadowBlur = 10;
    fingerNames.forEach(name => {
        const f = map[name];
        const w = project(lm[0]), start = project(lm[f[0]]);
        ctx.beginPath(); ctx.moveTo(w.x, w.y); ctx.lineTo(start.x, start.y); ctx.stroke();
        for (let i = 0; i < f.length - 1; i++) {
            const a = project(lm[f[i]]), b = project(lm[f[i+1]]);
            ctx.beginPath(); ctx.moveTo(a.x, a.y); ctx.lineTo(b.x, b.y); ctx.stroke();
        }
    });
    ctx.shadowBlur = 0;
    
    const pulse = 1 + Math.sin(state.animTime * 4) * 0.18;
    indices.forEach(idx => {
        const p = project(lm[idx]);
        const size = (idx === 0 ? 11 : 9) * pulse;
        ctx.fillStyle = color + '40'; ctx.beginPath(); ctx.arc(p.x, p.y, size + 5, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = color; ctx.beginPath(); ctx.arc(p.x, p.y, size, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(p.x, p.y, size * 0.35, 0, Math.PI * 2); ctx.fill();
    });
}

function renderPinch(lm, targets) {
    const [t1, t2] = targets;
    const f1 = t1 === 4 ? FINGER.THUMB : FINGER.INDEX;
    const f2 = t2 === 8 ? FINGER.INDEX : FINGER.MIDDLE;
    const indices = [0, ...f1, ...f2];
    const p1 = project(lm[t1]), p2 = project(lm[t2]);
    const dist = Math.hypot(p1.x - p2.x, p1.y - p2.y);
    const touching = dist < 50;
    const color = touching ? '#68b37a' : '#87a878';
    
    ctx.strokeStyle = 'rgba(255,255,255,0.05)'; ctx.lineWidth = 1;
    BONES.forEach(([s, e]) => {
        if (!indices.includes(s) && !indices.includes(e)) {
            const a = project(lm[s]), b = project(lm[e]);
            ctx.beginPath(); ctx.moveTo(a.x, a.y); ctx.lineTo(b.x, b.y); ctx.stroke();
        }
    });
    
    ctx.strokeStyle = color; ctx.lineWidth = 3;
    [f1, f2].forEach(f => {
        const w = project(lm[0]), start = project(lm[f[0]]);
        ctx.beginPath(); ctx.moveTo(w.x, w.y); ctx.lineTo(start.x, start.y); ctx.stroke();
        for (let i = 0; i < f.length - 1; i++) {
            const a = project(lm[f[i]]), b = project(lm[f[i+1]]);
            ctx.beginPath(); ctx.moveTo(a.x, a.y); ctx.lineTo(b.x, b.y); ctx.stroke();
        }
    });
    
    ctx.strokeStyle = touching ? '#68b37a' : 'rgba(135,168,120,0.5)';
    ctx.setLineDash([6, 6]);
    ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();
    ctx.setLineDash([]);
    
    [t1, t2].forEach((tip, i) => {
        const p = project(lm[tip]);
        const pulse = 1 + Math.sin(state.animTime * 6 + i * Math.PI) * 0.25;
        const size = 14 * pulse;
        const grad = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, size * 2);
        grad.addColorStop(0, color + '60'); grad.addColorStop(1, color + '00');
        ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(p.x, p.y, size * 2, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = color; ctx.beginPath(); ctx.arc(p.x, p.y, size, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(p.x, p.y, size * 0.4, 0, Math.PI * 2); ctx.fill();
    });
}

function renderMinimal(lm) {
    ctx.fillStyle = 'rgba(255,255,255,0.6)';
    lm.forEach(pt => {
        const p = project(pt);
        ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI * 2); ctx.fill();
    });
}

// ============================================
// FEEDBACK & AUDIO
// ============================================
function showFeedback(txt) {
    el.feedback.textContent = txt;
    el.feedback.classList.add('show');
    setTimeout(() => el.feedback.classList.remove('show'), 1000);
}

function spawnParticles() {
    const colors = ['#68b37a', '#d4a574', '#e8998d', '#a8c99b', '#87a878'];
    for (let i = 0; i < 20; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.left = (30 + Math.random() * 40) + '%';
        p.style.top = (30 + Math.random() * 20) + '%';
        p.style.width = p.style.height = (6 + Math.random() * 10) + 'px';
        p.style.background = colors[Math.floor(Math.random() * colors.length)];
        p.style.animationDelay = (Math.random() * 0.3) + 's';
        el.view.appendChild(p);
        setTimeout(() => p.remove(), 2000);
    }
}

function playSound() {
    if (!audioCtx) return;
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    o.type = 'sine';
    o.frequency.setValueAtTime(523, audioCtx.currentTime);
    o.frequency.setValueAtTime(659, audioCtx.currentTime + 0.1);
    o.frequency.setValueAtTime(784, audioCtx.currentTime + 0.2);
    g.gain.setValueAtTime(0.12, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
    o.start(); o.stop(audioCtx.currentTime + 0.5);
}

const coach = { enabled: true, toggle() { this.enabled = !this.enabled; el.btnAudio.textContent = this.enabled ? 'üîä' : 'üîá'; } };
function speak(txt) {
    if (!coach.enabled || !window.speechSynthesis) return;
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(txt);
    u.rate = 0.95;
    speechSynthesis.speak(u);
}

// ============================================
// EVENT LISTENERS
// ============================================
el.btnQuit.addEventListener('click', () => { if (confirm('End session?')) endSession(); });
el.btnAudio.addEventListener('click', () => coach.toggle());
el.btnSkip.addEventListener('click', skip);

document.addEventListener('keydown', e => {
    if (e.key === 'Escape' && state.screen === 'SESSION' && confirm('End session?')) endSession();
    if (e.key === 's' && state.screen === 'SESSION') skip();
});

console.log('%cüå± HandHero v3.0', 'font-size:20px;font-weight:bold;color:#68b37a');
</script>
</body>
</html>

// ============================================
// DASHBOARD INTEGRATION
// ============================================
function saveSessionToDashboard() {
    const duration = Math.floor((Date.now() - state.startTime) / 1000);
    const mins = Math.floor(duration / 60);
    const secs = duration % 60;
    
    const valid = state.log.filter(l => !l.skipped);
    const avg = valid.length > 0 ? valid.reduce((s, l) => s + l.accuracy, 0) / valid.length : 0;
    
    let grade;
    if (avg >= 85) grade = 'A';
    else if (avg >= 70) grade = 'B+';
    else if (avg >= 55) grade = 'B';
    else grade = 'C';
    
    const sessionResult = {
        completed: state.completed,
        duration: `${mins}:${secs.toString().padStart(2, '0')}`,
        grade: grade,
        avgAccuracy: Math.round(avg),
        exercises: state.log.map(l => ({
            id: state.exercises.find(e => e.name === l.name)?.id || l.name.toLowerCase(),
            name: l.name,
            accuracy: l.accuracy,
            grade: l.grade
        }))
    };
    
    try {
        localStorage.setItem('handhero_lastSessionResult', JSON.stringify(sessionResult));
    } catch(e) {
        console.error('Could not save session:', e);
    }
}

// Override endSession to also save to dashboard
const originalEndSession = endSession;
endSession = function() {
    saveSessionToDashboard();
    originalEndSession();
    
    // Add "Back to Dashboard" button
    const completeOverlay = document.getElementById('overlay-complete');
    if (completeOverlay && !document.getElementById('btn-dashboard')) {
        const btn = document.createElement('button');
        btn.id = 'btn-dashboard';
        btn.className = 'btn-secondary';
        btn.style.marginTop = '12px';
        btn.textContent = '‚Üê Back to Dashboard';
        btn.onclick = () => window.location.href = 'handhero_dashboard.html';
        completeOverlay.querySelector('.overlay-content').appendChild(btn);
    }
};

// Check if we came from dashboard
const returnUrl = localStorage.getItem('handhero_returnUrl');
if (returnUrl) {
    localStorage.removeItem('handhero_returnUrl');
}