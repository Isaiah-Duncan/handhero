<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HandHero | Hand Therapy Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Light mode colors */
            --bg-primary: #fdfbf7;
            --bg-secondary: #faf8f5;
            --bg-glass: rgba(255, 255, 255, 0.95);
            --text-primary: #4a5568;
            --text-secondary: #718096;
            --border-color: rgba(255, 255, 255, 0.8);
            
            /* Brand colors */
            --color-sage: #87a878;
            --color-sage-dark: #6b9960;
            --color-sage-light: #a8c99b;
            --color-coral: #e8998d;
            --color-gold: #d4a574;
            --color-success: #68b37a;
            
            /* Zone colors */
            --zone-green: rgba(104, 200, 150, 0.55);
            --zone-green-solid: #68c896;
            --zone-blue: rgba(100, 180, 230, 0.50);
            --zone-blue-solid: #64b4e6;
            --zone-yellow: rgba(240, 200, 100, 0.50);
            --zone-yellow-solid: #f0c864;
            --zone-orange: rgba(240, 160, 100, 0.45);
            --zone-orange-solid: #f0a064;
            
            /* Skeleton color - consistent, never changes */
            --skeleton-color: rgba(120, 220, 180, 0.9);
            --skeleton-glow: rgba(120, 220, 180, 0.4);
        }
        
        [data-theme="dark"] {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-glass: rgba(30, 40, 60, 0.95);
            --text-primary: #e8e8e8;
            --text-secondary: #a0a0b0;
            --border-color: rgba(60, 80, 100, 0.5);
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Nunito', sans-serif; 
            background: var(--bg-primary); 
            color: var(--text-primary); 
            overflow: hidden; 
            user-select: none;
            transition: background 0.3s, color 0.3s;
        }
        
        /* App Container */
        #app-container { 
            position: relative; 
            width: 100vw; 
            height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        
        #video-bg { 
            position: absolute; 
            inset: 0; 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            transform: scaleX(-1); 
            filter: blur(30px) opacity(0.3); 
            z-index: 0;
        }
        
        [data-theme="dark"] #video-bg { filter: blur(30px) opacity(0.2) brightness(0.5); }
        
        /* Portal */
        #portal-wrapper { 
            position: relative; 
            width: 94vw; 
            height: 90vh; 
            max-width: 1300px; 
            z-index: 10; 
        }
        
        #portal-frame {
            position: relative;
            width: 100%; 
            height: 100%;
            border-radius: 28px;
            padding: 3px;
            background: linear-gradient(135deg, var(--color-sage), var(--color-gold));
            box-shadow: 0 20px 60px -10px rgba(0, 0, 0, 0.15);
            transition: all 0.4s ease;
        }
        
        #portal-frame.holding { background: linear-gradient(135deg, var(--zone-blue-solid), var(--color-sage)); }
        #portal-frame.success { background: linear-gradient(135deg, var(--zone-green-solid), var(--color-sage-light)); box-shadow: 0 0 60px rgba(104, 200, 150, 0.4); }
        
        #portal-view { 
            width: 100%; 
            height: 100%; 
            background: var(--bg-secondary); 
            border-radius: 25px; 
            overflow: hidden; 
            position: relative; 
        }
        
        #video-clean { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            width: 100vw; 
            height: 100vh; 
            object-fit: cover; 
            transform: translate(-50%, -50%) scaleX(-1); 
        }
        
        #output-canvas { 
            position: absolute; 
            inset: 0; 
            width: 100%; 
            height: 100%; 
            pointer-events: none; 
        }
        
        /* Top Control Bar */
        .top-control-bar {
            position: fixed;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 100;
            padding: 8px 16px;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-radius: 50px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        .ctrl-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: relative;
        }
        
        .ctrl-btn:hover { transform: scale(1.08); }
        .ctrl-btn:active { transform: scale(0.95); }
        
        .ctrl-btn svg { width: 22px; height: 22px; }
        
        /* End Session (X) - Coral/Red */
        .ctrl-btn.end-btn {
            background: linear-gradient(135deg, #e8998d, #d88880);
            color: white;
        }
        .ctrl-btn.end-btn:hover { background: linear-gradient(135deg, #d88880, #c87870); }
        
        /* Skip - Blue */
        .ctrl-btn.skip-btn {
            background: linear-gradient(135deg, #64b4e6, #5090c0);
            color: white;
        }
        .ctrl-btn.skip-btn:hover { background: linear-gradient(135deg, #5090c0, #4080b0); }
        
        /* Audio - Green when on, Red when off */
        .ctrl-btn.audio-btn {
            background: linear-gradient(135deg, #68c896, #58b080);
            color: white;
        }
        .ctrl-btn.audio-btn.off {
            background: linear-gradient(135deg, #a0a0a0, #808080);
        }
        .ctrl-btn.audio-btn.off svg .slash { display: block; }
        .ctrl-btn.audio-btn:not(.off) svg .slash { display: none; }
        
        /* Theme Toggle */
        .ctrl-btn.theme-btn {
            background: linear-gradient(135deg, #8080a0, #606080);
            color: white;
        }
        [data-theme="dark"] .ctrl-btn.theme-btn {
            background: linear-gradient(135deg, #f0c864, #e0b050);
        }
        
        /* Settings */
        .ctrl-btn.settings-btn {
            background: var(--bg-glass);
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
        }
        
        /* Divider */
        .ctrl-divider {
            width: 1px;
            height: 28px;
            background: var(--border-color);
        }
        
        /* HUD */
        #hud-layer { 
            position: absolute; 
            inset: 0; 
            pointer-events: none; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
            padding: 70px 20px 20px 20px; 
        }
        
        .top-row { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; }
        
        .glass-pill {
            background: var(--bg-glass);
            backdrop-filter: blur(16px);
            border: 1px solid var(--border-color);
            border-radius: 18px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
        }
        
        .instruction-banner { 
            padding: 16px 28px; 
            display: flex; 
            align-items: center; 
            gap: 16px; 
            max-width: 500px; 
        }
        .instruction-icon { font-size: 2.2rem; }
        .instruction-text { font-size: 1.25rem; font-weight: 700; color: var(--text-primary); }
        .instruction-sub { font-size: 0.9rem; color: var(--text-secondary); font-weight: 500; margin-top: 4px; }
        
        .progress-pill { padding: 10px 18px; font-size: 0.85rem; font-weight: 700; color: var(--text-secondary); }
        
        .stats-bar { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; }
        .stat-card { padding: 12px 20px; border-radius: 16px; display: flex; align-items: center; gap: 10px; }
        .stat-val { font-size: 1.3rem; font-weight: 800; color: var(--text-primary); }
        .stat-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); font-weight: 700; }
        
        /* Accuracy Display */
        .accuracy-display {
            padding: 14px 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }
        .accuracy-value {
            font-size: 2rem;
            font-weight: 800;
            transition: color 0.2s;
        }
        .accuracy-value.green { color: var(--zone-green-solid); }
        .accuracy-value.blue { color: var(--zone-blue-solid); }
        .accuracy-value.yellow { color: var(--zone-yellow-solid); }
        .accuracy-value.orange { color: var(--zone-orange-solid); }
        .accuracy-label {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-secondary);
            letter-spacing: 0.05em;
        }
        
        /* Progress Bar */
        #progress-bar-container { 
            position: absolute; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            height: 6px; 
            background: rgba(0,0,0,0.1); 
            border-radius: 0 0 25px 25px; 
            overflow: hidden; 
        }
        #progress-bar-fill { 
            height: 100%; 
            width: 0%; 
            background: linear-gradient(90deg, var(--zone-blue-solid), var(--zone-green-solid)); 
            transition: width 0.15s ease; 
        }
        
        /* Center Instruction (Fist emoji popup) */
        .center-instruction {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 20;
        }
        .center-instruction.show { opacity: 1; }
        .center-emoji { font-size: 5rem; margin-bottom: 16px; filter: drop-shadow(0 4px 20px rgba(0,0,0,0.2)); }
        .center-text { 
            font-size: 1.4rem; 
            font-weight: 700; 
            color: white; 
            text-shadow: 0 2px 20px rgba(0,0,0,0.5);
            background: rgba(0,0,0,0.4);
            padding: 14px 32px;
            border-radius: 16px;
            backdrop-filter: blur(10px);
        }
        
        /* Success Feedback */
        #feedback-message { 
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem; 
            font-weight: 800; 
            color: var(--zone-green-solid); 
            text-shadow: 0 4px 30px rgba(104, 200, 150, 0.5); 
            opacity: 0; 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
            z-index: 25;
        }
        #feedback-message.show { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
        
        /* Particles */
        .particle { position: absolute; pointer-events: none; border-radius: 50%; animation: particle-fall 1.5s ease-out forwards; }
        @keyframes particle-fall { 0% { opacity: 1; transform: translateY(0) rotate(0deg); } 100% { opacity: 0; transform: translateY(200px) rotate(720deg); } }
        
        /* Skip Suggestion Toast */
        .skip-toast {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(30px);
            background: var(--bg-glass);
            padding: 14px 24px;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 16px;
            opacity: 0;
            transition: all 0.4s;
            pointer-events: none;
            z-index: 30;
        }
        .skip-toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }
        .skip-toast-text { font-size: 0.95rem; font-weight: 600; color: var(--text-primary); }
        .skip-toast-btn {
            padding: 8px 18px;
            border-radius: 10px;
            border: none;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }
        .skip-toast-btn.yes { background: var(--zone-blue-solid); color: white; }
        .skip-toast-btn.no { background: transparent; color: var(--text-secondary); }
        
        /* Overlays */
        .overlay-screen {
            position: fixed;
            inset: 0;
            z-index: 200;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .overlay-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .overlay-content { max-width: 480px; width: 100%; text-align: center; }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px 32px;
            border-radius: 14px;
            font-size: 1rem;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--color-sage) 0%, var(--color-sage-dark) 100%);
            color: white;
            box-shadow: 0 8px 24px -4px rgba(135, 168, 120, 0.4);
        }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: var(--bg-glass); color: var(--text-primary); border: 2px solid var(--border-color); }
        .btn-secondary:hover { border-color: var(--color-sage); }
        .btn-ghost { background: transparent; color: var(--text-secondary); padding: 12px 20px; }
        .btn-ghost:hover { color: var(--text-primary); }
        
        /* Onboarding */
        .onboarding-step { display: none; }
        .onboarding-step.active { display: block; }
        .onboarding-image { font-size: 5rem; margin-bottom: 24px; }
        .onboarding-title { font-size: 1.9rem; font-weight: 800; color: var(--text-primary); margin-bottom: 12px; }
        .onboarding-desc { font-size: 1rem; color: var(--text-secondary); line-height: 1.6; margin-bottom: 28px; }
        .onboarding-dots { display: flex; justify-content: center; gap: 8px; margin-bottom: 24px; }
        .onboarding-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--border-color); transition: all 0.3s; }
        .onboarding-dot.active { background: var(--color-sage); width: 28px; border-radius: 5px; }
        
        /* Disclaimer */
        .disclaimer-box { 
            background: var(--bg-glass); 
            border: 1px solid var(--border-color); 
            border-radius: 14px; 
            padding: 18px; 
            text-align: left; 
            margin-bottom: 20px; 
            max-height: 160px; 
            overflow-y: auto; 
        }
        .disclaimer-box h4 { font-weight: 700; color: var(--text-primary); margin-bottom: 8px; font-size: 0.95rem; }
        .disclaimer-box p, .disclaimer-box ul { font-size: 0.8rem; color: var(--text-secondary); line-height: 1.5; margin-bottom: 6px; }
        .disclaimer-box ul { padding-left: 18px; }
        .checkbox-row { display: flex; align-items: flex-start; gap: 12px; text-align: left; margin-bottom: 20px; }
        .checkbox-row input[type="checkbox"] { width: 20px; height: 20px; margin-top: 2px; accent-color: var(--color-sage); }
        .checkbox-row label { font-size: 0.85rem; color: var(--text-primary); line-height: 1.4; }
        
        /* Ready Countdown Screen */
        .ready-overlay { 
            background: linear-gradient(135deg, rgba(135, 168, 120, 0.95), rgba(104, 200, 150, 0.95)); 
        }
        [data-theme="dark"] .ready-overlay {
            background: linear-gradient(135deg, rgba(40, 60, 50, 0.98), rgba(30, 50, 40, 0.98));
        }
        .ready-countdown { 
            font-size: 7rem; 
            font-weight: 800; 
            color: white; 
            text-shadow: 0 8px 40px rgba(0,0,0,0.2); 
            animation: pulse-scale 1s ease infinite;
        }
        @keyframes pulse-scale { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.08); } }
        .ready-preview { 
            background: rgba(255,255,255,0.95); 
            border-radius: 18px; 
            padding: 20px 36px; 
            margin-top: 28px; 
            display: inline-flex; 
            align-items: center; 
            gap: 16px; 
        }
        [data-theme="dark"] .ready-preview { background: rgba(30, 40, 50, 0.95); }
        .ready-icon { font-size: 2.2rem; }
        .ready-name { font-size: 1.3rem; font-weight: 700; color: var(--text-primary); }
        .ready-desc { font-size: 0.85rem; color: var(--text-secondary); }
        
        /* Pain Check */
        .pain-scale { display: flex; justify-content: space-between; gap: 10px; margin: 20px 0; }
        .pain-btn { 
            flex: 1; 
            padding: 16px 8px; 
            border-radius: 12px; 
            border: 3px solid transparent; 
            cursor: pointer; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 6px;
            transition: all 0.2s;
            background: var(--bg-glass);
        }
        .pain-btn:hover { transform: translateY(-3px); }
        .pain-btn.selected { border-color: var(--color-sage); }
        .pain-emoji { font-size: 1.8rem; }
        .pain-label { font-size: 0.75rem; font-weight: 700; color: var(--text-primary); }
        
        /* Rest Overlay */
        .rest-overlay { 
            background: linear-gradient(135deg, rgba(100, 180, 230, 0.95), rgba(104, 200, 150, 0.95)); 
        }
        .rest-timer { font-size: 4rem; font-weight: 800; color: white; text-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        .rest-message { font-size: 1.1rem; color: white; margin-top: 12px; opacity: 0.9; }
        
        /* Complete Overlay */
        .summary-card { 
            background: var(--bg-glass); 
            border: 1px solid var(--border-color); 
            border-radius: 18px; 
            padding: 20px; 
            margin-bottom: 20px; 
        }
        .summary-stat { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
        .summary-stat:last-child { border-bottom: none; }
        .summary-label { color: var(--text-secondary); font-weight: 500; }
        .summary-value { color: var(--text-primary); font-weight: 700; }
        .grade-badge { display: inline-block; padding: 6px 16px; border-radius: 8px; font-weight: 800; }
        .grade-a { background: rgba(104, 200, 150, 0.2); color: var(--zone-green-solid); }
        .grade-b { background: rgba(100, 180, 230, 0.2); color: var(--zone-blue-solid); }
        .grade-c { background: rgba(240, 200, 100, 0.2); color: var(--zone-yellow-solid); }
        .complete-buttons { display: flex; flex-direction: column; gap: 12px; margin-top: 20px; }
        
        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 280px;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 18px;
            padding: 20px;
            z-index: 150;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        .settings-panel.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .settings-title { font-size: 1rem; font-weight: 800; color: var(--text-primary); margin-bottom: 16px; }
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .setting-row:last-child { border-bottom: none; }
        .setting-label { font-size: 0.85rem; color: var(--text-primary); font-weight: 600; }
        .setting-desc { font-size: 0.7rem; color: var(--text-secondary); }
        .toggle-switch {
            width: 48px;
            height: 26px;
            background: var(--border-color);
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }
        .toggle-switch.on { background: var(--color-sage); }
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: transform 0.3s;
        }
        .toggle-switch.on::after { transform: translateX(22px); }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 300;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content { 
            background: var(--bg-primary); 
            border-radius: 20px; 
            padding: 28px; 
            max-width: 380px; 
            width: 90%; 
            text-align: center; 
        }
        .modal-title { font-size: 1.2rem; font-weight: 800; color: var(--text-primary); margin-bottom: 10px; }
        .modal-desc { color: var(--text-secondary); margin-bottom: 20px; font-size: 0.9rem; }
        .modal-buttons { display: flex; gap: 12px; justify-content: center; }
        
        /* Zone Legend */
        .zone-legend {
            position: absolute;
            bottom: 80px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            background: var(--bg-glass);
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        .zone-legend-title { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 4px; }
        .zone-legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.7rem; font-weight: 600; color: var(--text-primary); }
        .zone-dot { width: 12px; height: 12px; border-radius: 3px; }
        .zone-dot.green { background: var(--zone-green); border: 2px solid var(--zone-green-solid); }
        .zone-dot.blue { background: var(--zone-blue); border: 2px solid var(--zone-blue-solid); }
        .zone-dot.yellow { background: var(--zone-yellow); border: 2px solid var(--zone-yellow-solid); }
        
        /* Loading Screen */
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top-color: var(--color-sage);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; }
        }
    </style>
</head>
<body data-theme="light">
    <!-- Top Control Bar -->
    <div class="top-control-bar" id="control-bar">
        <button class="ctrl-btn end-btn" id="btn-end" title="End Session">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
        
        <button class="ctrl-btn skip-btn" id="btn-skip" title="Skip Exercise">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M6 18V6l8.5 6L6 18zm8.5 0V6h2v12h-2z"/>
            </svg>
        </button>
        
        <div class="ctrl-divider"></div>
        
        <button class="ctrl-btn audio-btn" id="btn-audio" title="Toggle Audio">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 9v6h4l5 5V4L7 9H3z"/>
                <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
                <path d="M14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                <line class="slash" x1="3" y1="3" x2="21" y2="21" stroke="currentColor" stroke-width="2"/>
            </svg>
        </button>
        
        <button class="ctrl-btn theme-btn" id="btn-theme" title="Toggle Dark Mode">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
        </button>
        
        <button class="ctrl-btn settings-btn" id="btn-settings" title="Settings">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
        </button>
    </div>
    
    <!-- Settings Panel -->
    <div class="settings-panel" id="settings-panel">
        <div class="settings-title">‚öôÔ∏è Settings</div>
        <div class="setting-row">
            <div>
                <div class="setting-label">Auto-advance</div>
                <div class="setting-desc">Automatically start next exercise</div>
            </div>
            <div class="toggle-switch on" id="toggle-autoadvance" onclick="toggleSetting('autoAdvance')"></div>
        </div>
        <div class="setting-row">
            <div>
                <div class="setting-label">Voice Coach</div>
                <div class="setting-desc">Spoken instructions</div>
            </div>
            <div class="toggle-switch on" id="toggle-voice" onclick="toggleSetting('voice')"></div>
        </div>
        <div class="setting-row">
            <div>
                <div class="setting-label">Sound Effects</div>
                <div class="setting-desc">Success sounds</div>
            </div>
            <div class="toggle-switch on" id="toggle-sounds" onclick="toggleSetting('sounds')"></div>
        </div>
        <div class="setting-row">
            <div>
                <div class="setting-label">Countdown Time</div>
                <div class="setting-desc">Between exercises</div>
            </div>
            <select id="countdown-select" style="padding: 6px 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary); font-family: inherit;">
                <option value="2">2 sec</option>
                <option value="3" selected>3 sec</option>
                <option value="4">4 sec</option>
            </select>
        </div>
    </div>

    <!-- Main Container -->
    <div id="app-container">
        <video id="video-bg" playsinline muted autoplay></video>
        <div id="portal-wrapper">
            <div id="portal-frame">
                <div id="portal-view">
                    <video id="video-clean" playsinline muted autoplay></video>
                    <canvas id="output-canvas"></canvas>
                    
                    <div id="hud-layer">
                        <div class="top-row">
                            <div class="glass-pill progress-pill">
                                <span id="exercise-progress">1 / 8</span>
                            </div>
                            <div class="glass-pill instruction-banner">
                                <span class="instruction-icon" id="instruction-icon">‚úä</span>
                                <div>
                                    <div class="instruction-text" id="instruction-text">Make a Fist</div>
                                    <div class="instruction-sub" id="instruction-sub">Close all fingers to begin</div>
                                </div>
                            </div>
                            <div class="glass-pill accuracy-display">
                                <span class="accuracy-value green" id="accuracy-value">0%</span>
                                <span class="accuracy-label">Accuracy</span>
                            </div>
                        </div>
                        
                        <!-- Center instruction popup -->
                        <div class="center-instruction" id="center-instruction">
                            <div class="center-emoji" id="center-emoji">‚úä</div>
                            <div class="center-text" id="center-text">Make a fist to begin</div>
                        </div>
                        
                        <div id="feedback-message">Nice!</div>

                        <div class="stats-bar">
                            <div class="glass-pill stat-card">
                                <span>üî•</span>
                                <div><div id="stat-streak" class="stat-val">0</div><div class="stat-label">Streak</div></div>
                            </div>
                            <div class="glass-pill stat-card">
                                <span>‚ú®</span>
                                <div><div id="stat-completed" class="stat-val">0</div><div class="stat-label">Done</div></div>
                            </div>
                            <div class="glass-pill progress-pill">
                                <span id="session-timer">0:00</span>
                            </div>
                        </div>
                        
                        <div class="zone-legend">
                            <div class="zone-legend-title">Accuracy Zones</div>
                            <div class="zone-legend-item"><div class="zone-dot green"></div> 85%+ Perfect</div>
                            <div class="zone-legend-item"><div class="zone-dot blue"></div> 65%+ Good</div>
                            <div class="zone-legend-item"><div class="zone-dot yellow"></div> 40%+ Keep trying</div>
                        </div>
                    </div>
                    
                    <!-- Skip suggestion toast -->
                    <div class="skip-toast" id="skip-toast">
                        <span class="skip-toast-text">Having trouble? Would you like to skip?</span>
                        <button class="skip-toast-btn yes" onclick="acceptSkip()">Skip</button>
                        <button class="skip-toast-btn no" onclick="dismissSkip()">Keep trying</button>
                    </div>

                    <div id="progress-bar-container">
                        <div id="progress-bar-fill"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- OVERLAY: Welcome -->
    <div id="overlay-welcome" class="overlay-screen">
        <div class="overlay-content">
            <div class="onboarding-step active" data-step="1">
                <div class="onboarding-image">üå±</div>
                <h1 class="onboarding-title">Welcome to HandHero</h1>
                <p class="onboarding-desc">Your personal hand therapy companion with real-time visual feedback.</p>
                <div class="onboarding-dots"><div class="onboarding-dot active"></div><div class="onboarding-dot"></div><div class="onboarding-dot"></div></div>
                <button class="btn btn-primary" onclick="nextStep()">Get Started</button>
            </div>
            <div class="onboarding-step" data-step="2">
                <div class="onboarding-image">üéØ</div>
                <h2 class="onboarding-title">How It Works</h2>
                <p class="onboarding-desc">
                    <strong>Step 1:</strong> Make a fist to reset<br>
                    <strong>Step 2:</strong> Follow the exercise<br><br>
                    Watch the shaded zones change color to show your accuracy!
                </p>
                <div class="onboarding-dots"><div class="onboarding-dot"></div><div class="onboarding-dot active"></div><div class="onboarding-dot"></div></div>
                <button class="btn btn-primary" onclick="nextStep()">Next</button>
                <button class="btn btn-ghost" onclick="prevStep()">Back</button>
            </div>
            <div class="onboarding-step" data-step="3">
                <div class="onboarding-image">‚öïÔ∏è</div>
                <h2 class="onboarding-title">Safety First</h2>
                <div class="disclaimer-box">
                    <h4>Medical Disclaimer</h4>
                    <p>HandHero is a wellness tool to supplement ‚Äì not replace ‚Äì professional care.</p>
                    <ul>
                        <li>NOT a medical device</li>
                        <li>Stop if you feel pain</li>
                    </ul>
                </div>
                <div class="checkbox-row">
                    <input type="checkbox" id="disclaimer-check">
                    <label for="disclaimer-check">I understand and will stop if I feel pain.</label>
                </div>
                <div class="onboarding-dots"><div class="onboarding-dot"></div><div class="onboarding-dot"></div><div class="onboarding-dot active"></div></div>
                <button class="btn btn-primary" id="btn-start" disabled onclick="startApp()">Begin</button>
                <button class="btn btn-ghost" onclick="prevStep()">Back</button>
            </div>
        </div>
    </div>

    <!-- OVERLAY: Ready Countdown -->
    <div id="overlay-ready" class="overlay-screen ready-overlay hidden">
        <div class="overlay-content">
            <p style="color: white; font-size: 1rem; margin-bottom: 8px; opacity: 0.8;">Next Exercise</p>
            <div class="ready-countdown" id="ready-countdown">3</div>
            <div class="ready-preview">
                <span class="ready-icon" id="ready-icon">‚òùÔ∏è</span>
                <div style="text-align: left;">
                    <div class="ready-name" id="ready-name">Pointer</div>
                    <div class="ready-desc" id="ready-desc">Extend only index finger</div>
                </div>
            </div>
        </div>
    </div>

    <!-- OVERLAY: Pain Check -->
    <div id="overlay-pain" class="overlay-screen hidden">
        <div class="overlay-content">
            <div class="onboarding-image">üíö</div>
            <h2 class="onboarding-title">How are you feeling?</h2>
            <div class="pain-scale">
                <button class="pain-btn" onclick="selectPain(0)"><span class="pain-emoji">üòä</span><span class="pain-label">Great</span></button>
                <button class="pain-btn" onclick="selectPain(1)"><span class="pain-emoji">üòê</span><span class="pain-label">Mild</span></button>
                <button class="pain-btn" onclick="selectPain(2)"><span class="pain-emoji">üòï</span><span class="pain-label">Moderate</span></button>
                <button class="pain-btn" onclick="selectPain(3)"><span class="pain-emoji">üò£</span><span class="pain-label">Stop</span></button>
            </div>
            <button class="btn btn-primary" id="btn-continue-pain" disabled onclick="continuePain()">Continue</button>
        </div>
    </div>

    <!-- OVERLAY: Rest -->
    <div id="overlay-rest" class="overlay-screen rest-overlay hidden">
        <div class="overlay-content">
            <h2 class="onboarding-title" style="color: white;">Quick Break</h2>
            <div class="rest-timer" id="rest-timer">8</div>
            <p class="rest-message">Shake out your hand</p>
            <button class="btn btn-secondary" onclick="skipRest()" style="margin-top: 16px;">I'm Ready</button>
        </div>
    </div>

    <!-- OVERLAY: Complete -->
    <div id="overlay-complete" class="overlay-screen hidden">
        <div class="overlay-content">
            <div class="onboarding-image">üéâ</div>
            <h2 class="onboarding-title">Session Complete!</h2>
            <div class="summary-card">
                <div class="summary-stat"><span class="summary-label">Exercises</span><span class="summary-value" id="sum-done">8</span></div>
                <div class="summary-stat"><span class="summary-label">Duration</span><span class="summary-value" id="sum-time">4:30</span></div>
                <div class="summary-stat"><span class="summary-label">Best Streak</span><span class="summary-value" id="sum-streak">5 üî•</span></div>
                <div class="summary-stat"><span class="summary-label">Avg Accuracy</span><span class="summary-value" id="sum-accuracy">78%</span></div>
                <div class="summary-stat"><span class="summary-label">Grade</span><span class="summary-value"><span id="sum-grade" class="grade-badge grade-a">A</span></span></div>
            </div>
            <div class="complete-buttons">
                <button class="btn btn-primary" onclick="goHome()">üè† Dashboard</button>
                <button class="btn btn-secondary" onclick="newSession()">üîÑ New Session</button>
            </div>
        </div>
    </div>

    <!-- OVERLAY: Loading -->
    <div id="overlay-loading" class="overlay-screen hidden">
        <div class="overlay-content">
            <div class="loading-spinner"></div>
            <h2 class="onboarding-title">Setting Up</h2>
            <p class="onboarding-desc" id="loading-msg">Loading hand tracking...</p>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="modal-confirm" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title" id="modal-title">End Session?</h3>
            <p class="modal-desc" id="modal-desc">Your progress will be saved.</p>
            <div class="modal-buttons">
                <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmEndSession()">End</button>
            </div>
        </div>
    </div>

<script>
// ============================================
// CONFIGURATION
// ============================================
const CONFIG = {
    EXERCISES_PER_SESSION: 8,
    REST_SECONDS: 8,
    PAIN_CHECK_EVERY: 4,
    
    // Thresholds
    ZONE_GREEN: 0.85,
    ZONE_BLUE: 0.65,
    ZONE_YELLOW: 0.40,
    
    // Timing
    HOLD_DURATION_MS: 2200,
    RESET_HOLD_MS: 600,
    STRUGGLE_TIME_MS: 8000, // Show skip suggestion after this
    
    // Boundary detection (distance from finger in normalized coords)
    BOUNDARY_MARGIN: 0.025, // ~2.5% of screen = forgiving boundary
    
    // Progress decay (slow, doesn't reset)
    PROGRESS_DECAY_RATE: 0.008,
};

// Settings
const settings = {
    autoAdvance: true,
    voice: true,
    sounds: true,
    countdownTime: 3,
};

// ============================================
// FINGER CONSTANTS
// ============================================
const FINGER_TIPS = [4, 8, 12, 16, 20];
const FINGER_BASES = [1, 5, 9, 13, 17];
const FINGER_MIDS = [2, 6, 10, 14, 18];
const FINGER_NAMES = ['Thumb', 'Index', 'Middle', 'Ring', 'Pinky'];

const FINGER = {
    THUMB: [1, 2, 3, 4],
    INDEX: [5, 6, 7, 8],
    MIDDLE: [9, 10, 11, 12],
    RING: [13, 14, 15, 16],
    PINKY: [17, 18, 19, 20]
};
const FINGER_ARRAYS = [FINGER.THUMB, FINGER.INDEX, FINGER.MIDDLE, FINGER.RING, FINGER.PINKY];

// ============================================
// EXERCISE LIBRARY
// ============================================
const ALL_EXERCISES = [
    // Isolation exercises
    { id: 'thumbs_up', name: 'Thumbs Up', icon: 'üëç', desc: 'Extend only your thumb', difficulty: 2, type: 'isolation', targetFingers: [0] },
    { id: 'pointer', name: 'Pointer', icon: '‚òùÔ∏è', desc: 'Extend only your index finger', difficulty: 2, type: 'isolation', targetFingers: [1] },
    { id: 'middle_lift', name: 'Middle Finger', icon: 'üñï', desc: 'Extend only your middle finger', difficulty: 3, type: 'isolation', targetFingers: [2] },
    { id: 'ring_lift', name: 'Ring Finger', icon: 'üíç', desc: 'Extend only your ring finger', difficulty: 4, type: 'isolation', targetFingers: [3] },
    { id: 'pinky_out', name: 'Pinky', icon: 'ü§ô', desc: 'Extend only your pinky', difficulty: 3, type: 'isolation', targetFingers: [4] },
    
    // Two finger combinations
    { id: 'peace', name: 'Peace Sign', icon: '‚úåÔ∏è', desc: 'Extend index and middle', difficulty: 2, type: 'isolation', targetFingers: [1, 2] },
    { id: 'rock_on', name: 'Rock On', icon: 'ü§ò', desc: 'Extend index and pinky', difficulty: 4, type: 'isolation', targetFingers: [1, 4] },
    
    // Pinch exercises
    { id: 'ok_sign', name: 'OK Sign', icon: 'üëå', desc: 'Touch thumb to index tip', difficulty: 2, type: 'pinch', pinchPair: [4, 8] },
    { id: 'thumb_middle', name: 'Thumb to Middle', icon: 'ü§å', desc: 'Touch thumb to middle tip', difficulty: 2, type: 'pinch', pinchPair: [4, 12] },
    { id: 'thumb_ring', name: 'Thumb to Ring', icon: 'ü§è', desc: 'Touch thumb to ring tip', difficulty: 3, type: 'pinch', pinchPair: [4, 16] },
    { id: 'thumb_pinky', name: 'Thumb to Pinky', icon: 'ü§ô', desc: 'Touch thumb to pinky tip', difficulty: 3, type: 'pinch', pinchPair: [4, 20] },
    
    // Full hand
    { id: 'starfish', name: 'Starfish', icon: 'üñêÔ∏è', desc: 'Spread all fingers wide', difficulty: 1, type: 'spread' },
    { id: 'flat', name: 'Flat Hand', icon: 'ü§ö', desc: 'Fingers together, extended', difficulty: 1, type: 'flat' },
];

function selectExercises() {
    const shuffle = a => [...a].sort(() => Math.random() - 0.5);
    const byDiff = d => ALL_EXERCISES.filter(e => e.difficulty === d);
    const selected = [
        ...shuffle(byDiff(1)).slice(0, 2),
        ...shuffle(byDiff(2)).slice(0, 3),
        ...shuffle(byDiff(3)).slice(0, 2),
        ...shuffle(byDiff(4)).slice(0, 1),
    ];
    return shuffle(selected);
}

// ============================================
// STATE
// ============================================
const state = {
    step: 1,
    screen: 'WELCOME',
    handLandmarker: null,
    webcamRunning: false,
    animationFrameId: null,
    
    exercises: [],
    exIdx: 0,
    completed: 0,
    streak: 0,
    bestStreak: 0,
    startTime: 0,
    
    // Phase: RESET -> EXECUTE
    phase: 'RESET',
    resetProgress: 0,
    
    // Exercise tracking
    progress: 0,
    currentAcc: 0,
    peakAcc: 0,
    
    // Struggle detection
    exerciseStartTime: 0,
    skipToastShown: false,
    
    // Hand data
    landmarks: null,
    
    // Boundary-based detection results
    boundaryResults: {
        fingerZones: [0, 0, 0, 0, 0], // 0-1 score for each finger
        overallScore: 0,
    },
    
    log: [],
    painLevels: [],
    selectedPain: null,
    modalAction: null,
    settingsOpen: false,
};

// ============================================
// DOM REFERENCES
// ============================================
const $ = id => document.getElementById(id);
const el = {
    welcome: $('overlay-welcome'),
    loading: $('overlay-loading'),
    ready: $('overlay-ready'),
    pain: $('overlay-pain'),
    rest: $('overlay-rest'),
    complete: $('overlay-complete'),
    
    videoBg: $('video-bg'),
    video: $('video-clean'),
    canvas: $('output-canvas'),
    frame: $('portal-frame'),
    view: $('portal-view'),
    
    controlBar: $('control-bar'),
    btnEnd: $('btn-end'),
    btnSkip: $('btn-skip'),
    btnAudio: $('btn-audio'),
    btnTheme: $('btn-theme'),
    btnSettings: $('btn-settings'),
    settingsPanel: $('settings-panel'),
    
    icon: $('instruction-icon'),
    text: $('instruction-text'),
    sub: $('instruction-sub'),
    progress: $('exercise-progress'),
    timer: $('session-timer'),
    
    accuracyValue: $('accuracy-value'),
    
    centerInstruction: $('center-instruction'),
    centerEmoji: $('center-emoji'),
    centerText: $('center-text'),
    
    feedback: $('feedback-message'),
    bar: $('progress-bar-fill'),
    
    skipToast: $('skip-toast'),
    
    streak: $('stat-streak'),
    done: $('stat-completed'),
    
    readyCountdown: $('ready-countdown'),
    readyIcon: $('ready-icon'),
    readyName: $('ready-name'),
    readyDesc: $('ready-desc'),
    
    restTimer: $('rest-timer'),
    btnContinuePain: $('btn-continue-pain'),
    
    sumDone: $('sum-done'),
    sumTime: $('sum-time'),
    sumStreak: $('sum-streak'),
    sumAccuracy: $('sum-accuracy'),
    sumGrade: $('sum-grade'),
    
    loadMsg: $('loading-msg'),
    disclaimerCheck: $('disclaimer-check'),
    btnStart: $('btn-start'),
    
    modal: $('modal-confirm'),
};

const ctx = el.canvas.getContext('2d');
let audioCtx = null;

// ============================================
// THEME & SETTINGS
// ============================================
function toggleTheme() {
    const isDark = document.body.getAttribute('data-theme') === 'dark';
    document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
    localStorage.setItem('handhero_theme', isDark ? 'light' : 'dark');
}

function toggleAudio() {
    settings.sounds = !settings.sounds;
    settings.voice = !settings.voice;
    el.btnAudio.classList.toggle('off', !settings.sounds);
}

function toggleSetting(key) {
    settings[key] = !settings[key];
    const toggle = $('toggle-' + key.toLowerCase().replace('advance', 'autoadvance'));
    if (toggle) toggle.classList.toggle('on', settings[key]);
    
    if (key === 'sounds' || key === 'voice') {
        el.btnAudio.classList.toggle('off', !settings.sounds && !settings.voice);
    }
}

function toggleSettings() {
    state.settingsOpen = !state.settingsOpen;
    el.settingsPanel.classList.toggle('show', state.settingsOpen);
}

// Load saved theme
const savedTheme = localStorage.getItem('handhero_theme');
if (savedTheme) document.body.setAttribute('data-theme', savedTheme);

// ============================================
// ONBOARDING
// ============================================
function nextStep() {
    state.step++;
    updateStepUI();
}

function prevStep() {
    state.step--;
    updateStepUI();
}

function updateStepUI() {
    document.querySelectorAll('.onboarding-step').forEach((s, i) => s.classList.toggle('active', i + 1 === state.step));
    document.querySelectorAll('.onboarding-dot').forEach((d, i) => d.classList.toggle('active', i + 1 === state.step));
}

el.disclaimerCheck.addEventListener('change', e => el.btnStart.disabled = !e.target.checked);

// ============================================
// INITIALIZATION
// ============================================
async function startApp() {
    if (!el.disclaimerCheck.checked) return;
    
    el.welcome.classList.add('hidden');
    el.loading.classList.remove('hidden');
    
    try {
        el.loadMsg.textContent = 'Loading AI model...';
        
        const vision = await import("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js");
        const fs = await vision.FilesetResolver.forVisionTasks(
            "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
        );
        
        state.handLandmarker = await vision.HandLandmarker.createFromOptions(fs, {
            baseOptions: {
                modelAssetPath: 'https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task',
                delegate: 'GPU'
            },
            runningMode: 'VIDEO',
            numHands: 1
        });
        
        el.loadMsg.textContent = 'Starting camera...';
        
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { width: 1280, height: 720, facingMode: 'user' }
        });
        
        el.videoBg.srcObject = stream;
        el.video.srcObject = stream;
        
        await new Promise(resolve => { el.video.onloadeddata = resolve; });
        
        state.webcamRunning = true;
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        el.loading.classList.add('hidden');
        el.controlBar.style.display = 'flex';
        beginSession();
        
    } catch (e) {
        console.error('Init error:', e);
        el.loadMsg.textContent = 'Error: ' + e.message;
    }
}

// ============================================
// SESSION MANAGEMENT
// ============================================
function beginSession() {
    state.exercises = selectExercises();
    state.exIdx = 0;
    state.completed = 0;
    state.streak = 0;
    state.bestStreak = 0;
    state.startTime = Date.now();
    state.log = [];
    state.painLevels = [];
    
    showReadyScreen(0);
}

function showReadyScreen(idx) {
    state.screen = 'READY';
    state.exIdx = idx;
    
    const ex = state.exercises[idx];
    el.readyIcon.textContent = ex.icon;
    el.readyName.textContent = ex.name;
    el.readyDesc.textContent = ex.desc;
    
    el.ready.classList.remove('hidden');
    
    let count = settings.countdownTime;
    el.readyCountdown.textContent = count;
    
    const interval = setInterval(() => {
        count--;
        el.readyCountdown.textContent = count;
        
        if (count <= 0) {
            clearInterval(interval);
            el.ready.classList.add('hidden');
            startExercise(idx);
        }
    }, 1000);
    
    if (settings.voice) speak(`Next: ${ex.name}. ${ex.desc}`);
}

function startExercise(idx) {
    state.screen = 'SESSION';
    state.exIdx = idx;
    
    const ex = state.exercises[idx];
    
    // Always start with fist/reset phase
    state.phase = 'RESET';
    state.resetProgress = 0;
    state.progress = 0;
    state.currentAcc = 0;
    state.peakAcc = 0;
    state.exerciseStartTime = Date.now();
    state.skipToastShown = false;
    
    // Show fist instruction
    el.icon.textContent = '‚úä';
    el.text.textContent = 'Make a Fist';
    el.sub.textContent = 'Close all fingers to begin';
    el.progress.textContent = `${idx + 1} / ${state.exercises.length}`;
    
    el.centerEmoji.textContent = '‚úä';
    el.centerText.textContent = 'Make a fist to begin';
    el.centerInstruction.classList.add('show');
    
    el.bar.style.width = '0%';
    el.frame.className = '';
    
    if (!state.animationFrameId) gameLoop();
}

// ============================================
// GAME LOOP
// ============================================
function gameLoop() {
    if (!state.webcamRunning) return;
    
    if (state.screen === 'SESSION') {
        try {
            const results = state.handLandmarker.detectForVideo(el.video, performance.now());
            
            resizeCanvas();
            ctx.clearRect(0, 0, el.canvas.width, el.canvas.height);
            
            if (results.landmarks && results.landmarks.length > 0) {
                state.landmarks = results.landmarks[0];
                
                // Calculate boundary-based accuracy
                calculateBoundaryAccuracy();
                
                if (state.phase === 'RESET') {
                    updateResetPhase();
                } else {
                    updateExecutePhase();
                }
                
                // Render visuals
                renderVisuals();
            } else {
                state.landmarks = null;
                // Slow decay, don't reset
                state.progress = Math.max(0, state.progress - CONFIG.PROGRESS_DECAY_RATE);
                el.bar.style.width = (state.progress * 100) + '%';
            }
        } catch (e) {}
    }
    
    updateTimer();
    state.animationFrameId = requestAnimationFrame(gameLoop);
}

function updateTimer() {
    if (state.startTime) {
        const s = Math.floor((Date.now() - state.startTime) / 1000);
        el.timer.textContent = `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, '0')}`;
    }
}

// ============================================
// BOUNDARY-BASED ACCURACY CALCULATION
// ============================================
function calculateBoundaryAccuracy() {
    const lm = state.landmarks;
    if (!lm) return;
    
    const ex = state.exercises[state.exIdx];
    
    // Calculate finger extension scores using boundary zones
    const fingerScores = [];
    
    for (let i = 0; i < 5; i++) {
        const finger = FINGER_ARRAYS[i];
        const tip = lm[finger[3]];
        const base = lm[finger[0]];
        const wrist = lm[0];
        
        // Extension: tip distance from wrist relative to base
        const tipDist = Math.hypot(tip.x - wrist.x, tip.y - wrist.y);
        const baseDist = Math.hypot(base.x - wrist.x, base.y - wrist.y);
        const extension = tipDist / (baseDist + 0.01);
        
        // Normalized score (1 = extended, 0 = curled)
        // Using boundary approach: scores smoothly transition
        let score;
        if (extension > 1.8) score = 1.0;
        else if (extension > 1.5) score = 0.85;
        else if (extension > 1.2) score = 0.65;
        else if (extension > 1.0) score = 0.45;
        else if (extension > 0.7) score = 0.25;
        else score = 0.1;
        
        fingerScores[i] = score;
    }
    
    state.boundaryResults.fingerZones = fingerScores;
    
    // Calculate overall accuracy based on exercise type
    if (ex.type === 'isolation') {
        const targets = ex.targetFingers;
        
        // Target fingers should be extended (high score)
        const targetScores = targets.map(i => fingerScores[i]);
        const targetAvg = avg(targetScores);
        
        // Non-target fingers should be curled (low score = good)
        const nonTargets = [0, 1, 2, 3, 4].filter(i => !targets.includes(i));
        const nonTargetScores = nonTargets.map(i => 1 - fingerScores[i]); // Invert: curled is good
        const nonTargetAvg = nonTargets.length > 0 ? avg(nonTargetScores) : 1;
        
        // Weighted: target extension matters more, but isolation is required
        // More forgiving weighting
        state.currentAcc = targetAvg * 0.65 + nonTargetAvg * 0.35;
        
    } else if (ex.type === 'pinch') {
        const [p1, p2] = ex.pinchPair;
        const dist = Math.hypot(lm[p1].x - lm[p2].x, lm[p1].y - lm[p2].y);
        
        // Boundary-based pinch detection
        if (dist < 0.04) state.currentAcc = 1.0;
        else if (dist < 0.06) state.currentAcc = 0.9;
        else if (dist < 0.09) state.currentAcc = 0.75;
        else if (dist < 0.13) state.currentAcc = 0.55;
        else if (dist < 0.18) state.currentAcc = 0.35;
        else state.currentAcc = 0.15;
        
    } else if (ex.type === 'spread') {
        // All fingers extended + spread apart
        const allExtended = avg(fingerScores);
        
        // Calculate spread between adjacent fingers
        const gaps = [];
        for (let i = 0; i < 4; i++) {
            const t1 = lm[FINGER_TIPS[i]];
            const t2 = lm[FINGER_TIPS[i + 1]];
            gaps.push(Math.hypot(t1.x - t2.x, t1.y - t2.y));
        }
        const avgGap = avg(gaps);
        const spreadScore = avgGap > 0.12 ? 1 : avgGap > 0.08 ? 0.75 : avgGap > 0.05 ? 0.5 : 0.25;
        
        state.currentAcc = allExtended * 0.5 + spreadScore * 0.5;
        
    } else if (ex.type === 'flat') {
        const allExtended = avg(fingerScores);
        const gaps = [];
        for (let i = 0; i < 4; i++) {
            const t1 = lm[FINGER_TIPS[i]];
            const t2 = lm[FINGER_TIPS[i + 1]];
            gaps.push(Math.hypot(t1.x - t2.x, t1.y - t2.y));
        }
        const avgGap = avg(gaps);
        const togetherScore = avgGap < 0.05 ? 1 : avgGap < 0.08 ? 0.75 : 0.5;
        
        state.currentAcc = allExtended * 0.6 + togetherScore * 0.4;
    }
    
    // Track peak
    if (state.currentAcc > state.peakAcc) state.peakAcc = state.currentAcc;
    
    state.boundaryResults.overallScore = state.currentAcc;
}

function avg(arr) { return arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : 0; }

// ============================================
// RESET PHASE
// ============================================
function updateResetPhase() {
    const fingerScores = state.boundaryResults.fingerZones;
    
    // Check if all fingers are curled (low extension scores)
    const allCurled = fingerScores.every(s => s < 0.4);
    const avgCurl = avg(fingerScores.map(s => 1 - s)); // Inverted: curl score
    
    if (allCurled || avgCurl > 0.65) {
        // Progress toward reset completion
        state.resetProgress = Math.min(1, state.resetProgress + 0.025);
    } else {
        // Slow decay, don't reset to zero
        state.resetProgress = Math.max(0, state.resetProgress - CONFIG.PROGRESS_DECAY_RATE);
    }
    
    el.bar.style.width = (state.resetProgress * 50) + '%'; // First half of bar
    updateAccuracyDisplay(avgCurl);
    
    // Reset complete!
    if (state.resetProgress >= 1) {
        state.phase = 'EXECUTE';
        state.progress = 0;
        
        const ex = state.exercises[state.exIdx];
        el.icon.textContent = ex.icon;
        el.text.textContent = ex.name;
        el.sub.textContent = ex.desc;
        
        el.centerEmoji.textContent = ex.icon;
        el.centerText.textContent = ex.desc;
        
        if (settings.voice) {
            const targets = ex.targetFingers;
            if (targets) {
                const names = targets.map(i => FINGER_NAMES[i]).join(' and ');
                speak(`Good! Now extend your ${names}`);
            } else {
                speak(`Good! Now ${ex.desc}`);
            }
        }
    }
}

// ============================================
// EXECUTE PHASE
// ============================================
function updateExecutePhase() {
    const acc = state.currentAcc;
    
    updateAccuracyDisplay(acc);
    
    // Check for struggle (8 seconds in yellow or below)
    const elapsed = Date.now() - state.exerciseStartTime;
    if (elapsed > CONFIG.STRUGGLE_TIME_MS && state.peakAcc < CONFIG.ZONE_BLUE && !state.skipToastShown) {
        state.skipToastShown = true;
        el.skipToast.classList.add('show');
    }
    
    // Progress based on accuracy (doesn't reset, only decays slowly)
    if (acc >= CONFIG.ZONE_YELLOW) {
        // Add progress proportional to accuracy
        const addRate = 0.015 + acc * 0.02;
        state.progress = Math.min(1, state.progress + addRate);
    } else {
        // Slow decay
        state.progress = Math.max(0, state.progress - CONFIG.PROGRESS_DECAY_RATE);
    }
    
    el.bar.style.width = (50 + state.progress * 50) + '%'; // Second half
    
    // Success conditions
    if (state.progress >= 1 && acc >= CONFIG.ZONE_BLUE) {
        exerciseSuccess(acc);
    }
    
    // Frame color
    if (acc >= CONFIG.ZONE_GREEN) {
        el.frame.className = 'success';
    } else if (acc >= CONFIG.ZONE_BLUE) {
        el.frame.className = 'holding';
    } else {
        el.frame.className = '';
    }
}

function updateAccuracyDisplay(acc) {
    const pct = Math.round(acc * 100);
    el.accuracyValue.textContent = pct + '%';
    
    el.accuracyValue.classList.remove('green', 'blue', 'yellow', 'orange');
    if (acc >= CONFIG.ZONE_GREEN) el.accuracyValue.classList.add('green');
    else if (acc >= CONFIG.ZONE_BLUE) el.accuracyValue.classList.add('blue');
    else if (acc >= CONFIG.ZONE_YELLOW) el.accuracyValue.classList.add('yellow');
    else el.accuracyValue.classList.add('orange');
}

// ============================================
// VISUAL RENDERING
// ============================================
function resizeCanvas() {
    if (el.canvas.width !== el.view.clientWidth) {
        el.canvas.width = el.view.clientWidth;
        el.canvas.height = el.view.clientHeight;
    }
}

function project(pt) {
    const w = el.canvas.width, h = el.canvas.height;
    const scale = Math.max(w / 1280, h / 720);
    const sw = 1280 * scale, sh = 720 * scale;
    return { x: (w - sw) / 2 + (1 - pt.x) * sw, y: (h - sh) / 2 + pt.y * sh };
}

function renderVisuals() {
    const lm = state.landmarks;
    if (!lm) return;
    
    const ex = state.exercises[state.exIdx];
    const acc = state.phase === 'RESET' ? avg(state.boundaryResults.fingerZones.map(s => 1 - s)) : state.currentAcc;
    
    // Get zone color
    const zoneColor = getZoneColor(acc);
    const zoneSolid = getZoneSolidColor(acc);
    
    // Draw shaded zone based on exercise
    if (state.phase === 'EXECUTE') {
        if (ex.type === 'isolation' && ex.targetFingers) {
            drawIsolationZone(lm, ex.targetFingers, zoneColor, acc);
        } else if (ex.type === 'pinch' && ex.pinchPair) {
            drawPinchZone(lm, ex.pinchPair, zoneColor, acc);
        } else if (ex.type === 'spread' || ex.type === 'flat') {
            drawSpreadZone(lm, zoneColor, acc);
        }
    } else {
        // Reset phase - show zone around fist area
        drawFistZone(lm, zoneColor, acc);
    }
    
    // Draw skeleton (consistent color, no red/green flashing)
    drawSkeleton(lm);
}

function drawIsolationZone(lm, targets, color, acc) {
    const wrist = project(lm[0]);
    const tips = targets.map(i => project(lm[FINGER_TIPS[i]]));
    
    if (tips.length === 1) {
        // Single finger - draw wedge from wrist to finger
        const tip = tips[0];
        const finger = FINGER_ARRAYS[targets[0]];
        const base = project(lm[finger[0]]);
        
        // Create a wedge shape
        ctx.beginPath();
        ctx.moveTo(wrist.x, wrist.y);
        ctx.lineTo(base.x - 30, base.y);
        ctx.lineTo(tip.x - 20, tip.y);
        ctx.lineTo(tip.x + 20, tip.y);
        ctx.lineTo(base.x + 30, base.y);
        ctx.closePath();
        ctx.fillStyle = color;
        ctx.fill();
    } else {
        // Multiple fingers - polygon
        ctx.beginPath();
        ctx.moveTo(wrist.x, wrist.y);
        tips.forEach(t => ctx.lineTo(t.x, t.y));
        ctx.closePath();
        ctx.fillStyle = color;
        ctx.fill();
    }
    
    // Draw accuracy percentage
    const centerX = tips.reduce((s, t) => s + t.x, wrist.x) / (tips.length + 1);
    const centerY = tips.reduce((s, t) => s + t.y, wrist.y) / (tips.length + 1) - 40;
    
    ctx.font = 'bold 32px Nunito';
    ctx.fillStyle = 'white';
    ctx.textAlign = 'center';
    ctx.strokeStyle = 'rgba(0,0,0,0.3)';
    ctx.lineWidth = 4;
    ctx.strokeText(Math.round(acc * 100) + '%', centerX, centerY);
    ctx.fillText(Math.round(acc * 100) + '%', centerX, centerY);
}

function drawPinchZone(lm, pair, color, acc) {
    const [p1, p2] = pair;
    const pt1 = project(lm[p1]);
    const pt2 = project(lm[p2]);
    const wrist = project(lm[0]);
    
    // Triangle between fingertips and wrist
    ctx.beginPath();
    ctx.moveTo(pt1.x, pt1.y);
    ctx.lineTo(pt2.x, pt2.y);
    ctx.lineTo(wrist.x, wrist.y);
    ctx.closePath();
    ctx.fillStyle = color;
    ctx.fill();
    
    // Dotted line between tips
    ctx.setLineDash([8, 8]);
    ctx.strokeStyle = getZoneSolidColor(acc);
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(pt1.x, pt1.y);
    ctx.lineTo(pt2.x, pt2.y);
    ctx.stroke();
    ctx.setLineDash([]);
    
    // Percentage
    const midX = (pt1.x + pt2.x) / 2;
    const midY = (pt1.y + pt2.y) / 2 - 25;
    ctx.font = 'bold 28px Nunito';
    ctx.fillStyle = 'white';
    ctx.textAlign = 'center';
    ctx.strokeStyle = 'rgba(0,0,0,0.3)';
    ctx.lineWidth = 4;
    ctx.strokeText(Math.round(acc * 100) + '%', midX, midY);
    ctx.fillText(Math.round(acc * 100) + '%', midX, midY);
    
    // Target circles
    [pt1, pt2].forEach(p => {
        ctx.fillStyle = 'rgba(255,255,255,0.2)';
        ctx.beginPath();
        ctx.arc(p.x, p.y, 35, 0, Math.PI * 2);
        ctx.fill();
    });
}

function drawSpreadZone(lm, color, acc) {
    const wrist = project(lm[0]);
    const tips = FINGER_TIPS.map(i => project(lm[i]));
    
    // Draw zones between each adjacent finger
    for (let i = 0; i < tips.length - 1; i++) {
        ctx.beginPath();
        ctx.moveTo(tips[i].x, tips[i].y);
        ctx.lineTo(tips[i + 1].x, tips[i + 1].y);
        ctx.lineTo(wrist.x, wrist.y);
        ctx.closePath();
        ctx.fillStyle = color;
        ctx.fill();
    }
    
    // Center percentage
    ctx.font = 'bold 28px Nunito';
    ctx.fillStyle = 'white';
    ctx.textAlign = 'center';
    ctx.strokeStyle = 'rgba(0,0,0,0.3)';
    ctx.lineWidth = 4;
    ctx.strokeText(Math.round(acc * 100) + '%', wrist.x, wrist.y - 50);
    ctx.fillText(Math.round(acc * 100) + '%', wrist.x, wrist.y - 50);
}

function drawFistZone(lm, color, acc) {
    const wrist = project(lm[0]);
    const tips = FINGER_TIPS.map(i => project(lm[i]));
    const center = {
        x: tips.reduce((s, t) => s + t.x, 0) / tips.length,
        y: tips.reduce((s, t) => s + t.y, 0) / tips.length
    };
    
    // Circular zone around fist area
    ctx.beginPath();
    ctx.arc(center.x, center.y, 80, 0, Math.PI * 2);
    ctx.fillStyle = color;
    ctx.fill();
    
    // Percentage
    ctx.font = 'bold 28px Nunito';
    ctx.fillStyle = 'white';
    ctx.textAlign = 'center';
    ctx.fillText(Math.round(acc * 100) + '%', center.x, center.y);
}

function drawSkeleton(lm) {
    // CONSISTENT color - no red/green flashing
    const color = 'rgba(120, 220, 180, 0.9)';
    const glowColor = 'rgba(120, 220, 180, 0.4)';
    
    ctx.strokeStyle = color;
    ctx.lineWidth = 3;
    ctx.lineCap = 'round';
    ctx.shadowColor = glowColor;
    ctx.shadowBlur = 8;
    
    // Draw all bones
    FINGER_ARRAYS.forEach(finger => {
        const wrist = project(lm[0]);
        const base = project(lm[finger[0]]);
        
        ctx.beginPath();
        ctx.moveTo(wrist.x, wrist.y);
        ctx.lineTo(base.x, base.y);
        ctx.stroke();
        
        for (let i = 0; i < finger.length - 1; i++) {
            const a = project(lm[finger[i]]);
            const b = project(lm[finger[i + 1]]);
            ctx.beginPath();
            ctx.moveTo(a.x, a.y);
            ctx.lineTo(b.x, b.y);
            ctx.stroke();
        }
    });
    
    // Palm connections
    [[5, 9], [9, 13], [13, 17]].forEach(([a, b]) => {
        const pa = project(lm[a]);
        const pb = project(lm[b]);
        ctx.beginPath();
        ctx.moveTo(pa.x, pa.y);
        ctx.lineTo(pb.x, pb.y);
        ctx.stroke();
    });
    
    // Joints
    ctx.shadowBlur = 0;
    for (let i = 0; i <= 20; i++) {
        const p = project(lm[i]);
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.arc(p.x, p.y, 2, 0, Math.PI * 2);
        ctx.fill();
    }
}

function getZoneColor(acc) {
    if (acc >= CONFIG.ZONE_GREEN) return 'rgba(104, 200, 150, 0.55)';
    if (acc >= CONFIG.ZONE_BLUE) return 'rgba(100, 180, 230, 0.50)';
    if (acc >= CONFIG.ZONE_YELLOW) return 'rgba(240, 200, 100, 0.50)';
    return 'rgba(240, 160, 100, 0.45)';
}

function getZoneSolidColor(acc) {
    if (acc >= CONFIG.ZONE_GREEN) return '#68c896';
    if (acc >= CONFIG.ZONE_BLUE) return '#64b4e6';
    if (acc >= CONFIG.ZONE_YELLOW) return '#f0c864';
    return '#f0a064';
}

// ============================================
// EXERCISE SUCCESS
// ============================================
function exerciseSuccess(acc) {
    state.completed++;
    state.streak++;
    if (state.streak > state.bestStreak) state.bestStreak = state.streak;
    
    const ex = state.exercises[state.exIdx];
    const pct = Math.round(acc * 100);
    const grade = pct >= 90 ? 'A' : pct >= 80 ? 'A-' : pct >= 70 ? 'B+' : pct >= 60 ? 'B' : 'B-';
    
    state.log.push({ id: ex.id, name: ex.name, accuracy: pct, grade });
    
    showFeedback(acc >= 0.85 ? 'Perfect! üåü' : acc >= 0.70 ? 'Great job!' : 'Good effort!');
    if (settings.sounds) playSound();
    spawnParticles();
    
    el.done.textContent = state.completed;
    el.streak.textContent = state.streak;
    el.centerInstruction.classList.remove('show');
    el.skipToast.classList.remove('show');
    
    setTimeout(() => {
        const nextIdx = state.exIdx + 1;
        
        if (state.completed > 0 && state.completed % CONFIG.PAIN_CHECK_EVERY === 0 && nextIdx < state.exercises.length) {
            showPainCheck();
            return;
        }
        
        if (nextIdx >= state.exercises.length) {
            endSession();
            return;
        }
        
        if (settings.autoAdvance) {
            showReadyScreen(nextIdx);
        } else {
            // Manual advance - show button
            el.centerText.textContent = 'Tap Skip to continue';
            el.centerEmoji.textContent = 'üëâ';
            el.centerInstruction.classList.add('show');
        }
    }, 1500);
}

// ============================================
// SKIP HANDLING
// ============================================
function skipExercise() {
    if (state.screen !== 'SESSION') return;
    
    const ex = state.exercises[state.exIdx];
    state.log.push({ id: ex.id, name: ex.name, accuracy: Math.round(state.peakAcc * 100), grade: 'SKIP', skipped: true });
    state.streak = 0;
    el.streak.textContent = '0';
    el.skipToast.classList.remove('show');
    
    const nextIdx = state.exIdx + 1;
    if (nextIdx >= state.exercises.length) {
        endSession();
    } else {
        showReadyScreen(nextIdx);
    }
}

function acceptSkip() {
    skipExercise();
}

function dismissSkip() {
    el.skipToast.classList.remove('show');
    state.exerciseStartTime = Date.now(); // Reset timer
}

// ============================================
// PAIN CHECK & REST
// ============================================
function showPainCheck() {
    state.screen = 'PAIN';
    state.selectedPain = null;
    el.btnContinuePain.disabled = true;
    document.querySelectorAll('.pain-btn').forEach(b => b.classList.remove('selected'));
    el.pain.classList.remove('hidden');
}

function selectPain(level) {
    state.selectedPain = level;
    state.painLevels.push({ time: Date.now(), level });
    document.querySelectorAll('.pain-btn').forEach((b, i) => b.classList.toggle('selected', i === level));
    el.btnContinuePain.disabled = false;
    el.btnContinuePain.textContent = level === 3 ? 'End Session' : 'Continue';
}

function continuePain() {
    el.pain.classList.add('hidden');
    if (state.selectedPain === 3) { endSession(); return; }
    showRest();
}

let restInterval = null;
function showRest() {
    state.screen = 'REST';
    let remaining = CONFIG.REST_SECONDS;
    el.restTimer.textContent = remaining;
    el.rest.classList.remove('hidden');
    restInterval = setInterval(() => {
        remaining--;
        el.restTimer.textContent = remaining;
        if (remaining <= 0) skipRest();
    }, 1000);
}

function skipRest() {
    if (restInterval) { clearInterval(restInterval); restInterval = null; }
    el.rest.classList.add('hidden');
    const nextIdx = state.exIdx + 1;
    if (nextIdx >= state.exercises.length) endSession();
    else showReadyScreen(nextIdx);
}

// ============================================
// SESSION END
// ============================================
function endSession() {
    state.screen = 'COMPLETE';
    
    if (state.animationFrameId) {
        cancelAnimationFrame(state.animationFrameId);
        state.animationFrameId = null;
    }
    
    const duration = Math.floor((Date.now() - state.startTime) / 1000);
    const valid = state.log.filter(l => !l.skipped);
    const avgAcc = valid.length > 0 ? valid.reduce((s, l) => s + l.accuracy, 0) / valid.length : 0;
    
    let grade, gradeClass;
    if (avgAcc >= 85) { grade = 'A'; gradeClass = 'grade-a'; }
    else if (avgAcc >= 70) { grade = 'B+'; gradeClass = 'grade-b'; }
    else if (avgAcc >= 55) { grade = 'B'; gradeClass = 'grade-b'; }
    else { grade = 'C+'; gradeClass = 'grade-c'; }
    
    el.sumDone.textContent = state.completed;
    el.sumTime.textContent = `${Math.floor(duration / 60)}:${(duration % 60).toString().padStart(2, '0')}`;
    el.sumStreak.textContent = state.bestStreak + ' üî•';
    el.sumAccuracy.textContent = Math.round(avgAcc) + '%';
    el.sumGrade.textContent = grade;
    el.sumGrade.className = 'grade-badge ' + gradeClass;
    
    el.complete.classList.remove('hidden');
    
    // Save silently (NO ALERTS)
    try {
        const result = {
            completed: state.completed,
            duration: `${Math.floor(duration / 60)}:${(duration % 60).toString().padStart(2, '0')}`,
            grade,
            avgAccuracy: Math.round(avgAcc),
            bestStreak: state.bestStreak,
            exercises: state.log,
            date: new Date().toISOString()
        };
        localStorage.setItem('handhero_lastSessionResult', JSON.stringify(result));
    } catch (e) {}
}

function goHome() {
    window.location.href = 'handhero_dashboard.html';
}

function newSession() {
    el.complete.classList.add('hidden');
    beginSession();
}

// ============================================
// MODAL
// ============================================
function showEndModal() {
    el.modal.classList.add('show');
}

function closeModal() {
    el.modal.classList.remove('show');
}

function confirmEndSession() {
    closeModal();
    endSession();
}

// ============================================
// AUDIO & FEEDBACK
// ============================================
function showFeedback(text) {
    el.feedback.textContent = text;
    el.feedback.classList.add('show');
    setTimeout(() => el.feedback.classList.remove('show'), 1200);
}

function spawnParticles() {
    const colors = ['#68c896', '#64b4e6', '#f0c864', '#a8c99b'];
    for (let i = 0; i < 15; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.left = (30 + Math.random() * 40) + '%';
        p.style.top = (30 + Math.random() * 20) + '%';
        p.style.width = p.style.height = (6 + Math.random() * 10) + 'px';
        p.style.background = colors[Math.floor(Math.random() * colors.length)];
        el.view.appendChild(p);
        setTimeout(() => p.remove(), 2000);
    }
}

function playSound() {
    if (!audioCtx || !settings.sounds) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    o.type = 'sine';
    o.frequency.setValueAtTime(523, audioCtx.currentTime);
    o.frequency.setValueAtTime(659, audioCtx.currentTime + 0.1);
    o.frequency.setValueAtTime(784, audioCtx.currentTime + 0.2);
    g.gain.setValueAtTime(0.08, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
    o.start(); o.stop(audioCtx.currentTime + 0.4);
}

function speak(text) {
    if (!settings.voice || !window.speechSynthesis) return;
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.rate = 0.95;
    speechSynthesis.speak(u);
}

// ============================================
// EVENT LISTENERS
// ============================================
el.btnEnd.addEventListener('click', showEndModal);
el.btnSkip.addEventListener('click', skipExercise);
el.btnAudio.addEventListener('click', toggleAudio);
el.btnTheme.addEventListener('click', toggleTheme);
el.btnSettings.addEventListener('click', toggleSettings);

$('countdown-select').addEventListener('change', (e) => {
    settings.countdownTime = parseInt(e.target.value);
});

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') showEndModal();
    if (e.key === 's' && state.screen === 'SESSION') skipExercise();
});

document.addEventListener('click', (e) => {
    if (state.settingsOpen && !el.settingsPanel.contains(e.target) && e.target !== el.btnSettings) {
        toggleSettings();
    }
});

// Hide control bar initially
el.controlBar.style.display = 'none';

console.log('%cüå± HandHero v6.0', 'font-size: 24px; font-weight: bold; color: #68c896;');
console.log('%cBoundary-based detection + Clean UI', 'font-size: 14px; color: #64b4e6;');
</script>
</body>
</html>